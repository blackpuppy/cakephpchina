

<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta content="Dispatcher Filters" lang="zh" name="title" />
<meta content="Dispatcher filters are a middleware layer for CakePHP allowing to alter the request or response before it is sent" lang="zh" name="description" />
<meta content="middleware, filters, dispatcher, request, response, rack, application stack, events, beforeDispatch, afterDispatch, router" lang="zh" name="keywords" />

    <title>调度器过滤器</title>
    <link href="../_static/favicon.png" type="image/png" rel="icon" />

    
    <link rel="stylesheet" href="../_static/css/app.css" type="text/css" />
    
    <script type="text/javascript" src="../_static/app.js"></script>

    <link rel="alternate" hreflang="en" href="../../en/development/dispatch-filters.html" /><link rel="alternate" hreflang="pt" href="../../pt/development/dispatch-filters.html" /><link rel="alternate" hreflang="es" href="../../es/development/dispatch-filters.html" /><link rel="alternate" hreflang="ja" href="../../ja/development/dispatch-filters.html" /><link rel="alternate" hreflang="fr" href="../../fr/development/dispatch-filters.html" />

    <link rel="search" type="application/opensearchdescription+xml" title="Search within CakePHP Cookbook 2.x 文档" href="../_static/opensearchdescription-book-3-x.xml">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="top" title="CakePHP Cookbook 2.x 文档" href="../index.html" />
    <link rel="up" title="开发" href="../development.html" />
    <link rel="next" title="部署" href="../deployment.html" />
    <link rel="prev" title="REST" href="rest.html" />

    <script type="text/javascript">
    window.lang = "zh";
    </script>
  </head>
  <body>

<div id="container">
	
	<header class="nav-down">
		<div class="container-fluid hidden-xs hidden-sm">
			<div class="row">
				<div class="col-sm-3 col-md-3">
					<a class="logo-cake" href="http://cakephp.org">
						<img src="../_static/logo-cake.png" alt="CakePHP" />
					</a>
				</div>

				<div class="col-sm-9 col-md-9">
					<nav class="navbar-right">
						<ul class="menu">
							<li class="first">
								<a href="#"><i class="fa fa-menu fa-chevron-down"></i>Documentation</a>
								<ul class="submenu">
									
<li><a href="http://book.cakephp.org"><i class="fa fa-menu fa-chevron-right"></i>CookBook</a></li>
<li><a href="http://api.cakephp.org"><i class="fa fa-menu fa-chevron-right"></i>API</a></li>

<li><a href="http://cakephp.org/documentation/videos"><i class="fa fa-menu fa-chevron-right"></i>Videos</a></li>
<li><a href="http://cakephp.org/privacy"><i class="fa fa-menu fa-chevron-right"></i>Privacy Policy</a></li>
<li><a href="http://cakephp.org/pages/trademark"><i class="fa fa-menu fa-chevron-right"></i>Logos &amp; Trademarks</a></li>
								</ul>
							</li>

							<li><a href="http://cakephp.org/business-solutions">Business Solutions</a></li>
							<li><a href="http://cakephp.org/showcase">Showcase</a></li>

							<li>
								<a href="#"><i class="fa fa-menu fa-chevron-down"></i>Community</a>
								<div class="megamenu full">
									<div class="row">
										<div class="col-6 pl30">
											<ul class="megamenu-list">
												
<li class="menu-title"><i class="fa fa-menu-title fa-users"></i>Community</li>

<li><a href="http://cakephp.org/team"><i class="fa fa-menu fa-chevron-right"></i>Team</a></li>
<li><a href="https://github.com/cakephp/cakephp/issues"><i class="fa fa-menu fa-chevron-right"></i>Issues (Github)</a></li>
<li><a href="http://www.youtube.com/user/CakePHP"><i class="fa fa-menu fa-chevron-right"></i>YouTube Channel</a></li>
<li><a href="http://cakephp.org/get-involved"><i class="fa fa-menu fa-chevron-right"></i>Get Involved</a></li>

<li><a href="http://bakery.cakephp.org"><i class="fa fa-menu fa-chevron-right"></i>Bakery</a></li>
<li><a href="http://cakephp.org/newsletter/signup"><i class="fa fa-menu fa-chevron-right"></i>Newsletter</a></li>
<li><a href="http://certification.cakephp.org"><i class="fa fa-menu fa-chevron-right"></i>Certification</a></li>
<li><a href="http://my.cakephp.org"><i class="fa fa-menu fa-chevron-right"></i>My CakePHP</a></li>
<li><a href="http://cakefest.org"><i class="fa fa-menu fa-chevron-right"></i>CakeFest</a></li>
<li><a href="http://www.facebook.com/groups/cake.community"><i class="fa fa-menu fa-chevron-right"></i>Facebook</a></li>
<li><a href="http://twitter.com/cakephp"><i class="fa fa-menu fa-chevron-right"></i>Twitter</a></li>
											</ul>
										</div>
										<div class="col-6 pl30">
											<ul class="megamenu-list">
												
<li class="menu-title"><i class="fa fa-menu-title fa-comments-o"></i>Help &amp; Support</li>

<li><a href="http://discourse.cakephp.org"><i class="fa fa-menu fa-chevron-right"></i>Forum</a></li>
<li><a href="http://stackoverflow.com/tags/cakephp"><i class="fa fa-menu fa-chevron-right"></i>Stack Overflow</a></li>
<li><a href="http://webchat.freenode.net/?channels=cakephp"><i class="fa fa-menu fa-chevron-right"></i>IRC</a></li>
<li><a href="http://cakesf.herokuapp.com/"><i class="fa fa-menu fa-chevron-right"></i>Slack</a></li>
<li><a href="http://cakedc.com"><i class="fa fa-menu fa-chevron-right"></i>Paid Support</a></li>
											</ul>
										</div>
									</div>
								</div>
							</li>
						</ul>
					</nav>
				</div>
			</div>
		</div>

		
		<div class="container-fluid hidden-md hidden-lg">
			<div class="row">
				<div class="col-sm-6 col-xs-6">
					<a class="logo-cake" href="http://cakephp.org">
						<img src="../_static/logo-cake.png" alt="CakePHP" />
					</a>
				</div>

				<div class="col-sm-6 col-xs-6">
					<div class="navbar-right">
						<button id="btn-menu" class="btn-menu" data-toggle="modal" data-target="#modal">
							<i class="fa fa-bars toggle-modal"></i>
						</button>
					</div>
					<div id="wrap">
						<form class="search" action="../search.html" method="get">
							<input name="q" type="search" placeholder="What are you looking for?">
							<input id="search_submit" value="搜索" type="submit">
						</form>
					</div>
				</div>
			</div>
		</div>

		
		<section id="nav-cook" class="hidden-xs hidden-sm">
			<div class="container-fluid ">
				<div class="row ">
					<div class="col-md-12 back-book">
						<div class="col-md-4 col-md-offset-1 text-center t-cook-nav p0 hidden-sm hidden-xs">
							<h2>
								<a href="../contents.html">
									<span class="glyph_range icon-submenu icon-submenu-cook">B</span>
									CakePHP 2.x <strong>Cookbook</strong>
								</a>
							</h2>
						</div>

						<div class="col-md-4 hidden-sm">
							<form class="search" action="../search.html" method="get">
								<input type="hidden" name="check_keywords" value="yes" />
								<input type="hidden" name="area" value="default" />

								<div class="col-md-10 p0">
									<input class="form-control form-cook" autocomplete="off" type="search" name="q" size="18" placeholder='Cookbook Search' />
								</div>
								<div class="col-md-2 p0 search-cook">
									<button type="submit">
										<span class="glyph_range icon-submenu icon-submenu-cook">A</span>
									</button>
								</div>
							</form>
						</div>

						
						<div class="col-md-3">
							<div class="col-md-6 p0">
								<div class="col-md-7 t-language p0">
									<h6>Language:</h6>
								</div>
								<div class="col-md-5 p0">
									<ul class="nav navbar-nav">
										<li class="dropdown">
											<a class="dropdown-toggle" data-hover="dropdown" data-toggle="dropdown"
													role="button" aria-haspopup="true" aria-expanded="false" href="#">
														zh
														<i class="fa fa-menu-en fa-chevron-down"></i>
													</a>
											<ul class="dropdown-menu">
											
												<li><a href="../../en/development/dispatch-filters.html">en</a></li>
											
												<li><a href="../../pt/development/dispatch-filters.html">pt</a></li>
											
												<li><a href="../../es/development/dispatch-filters.html">es</a></li>
											
												<li><a href="../../ja/development/dispatch-filters.html">ja</a></li>
											
												<li><a href="../../fr/development/dispatch-filters.html">fr</a></li>
											
												<li></li>
											
											</ul>
										</li>
									</ul>
								</div>
							</div>

							<div class="col-md-6 p0">
								<div class="col-md-7 t-language p0">
									<h6>Version:</h6>
								</div>
								<div class="col-md-5 p0">
									<ul class="nav navbar-nav">
										<li class="dropdown">
											<a href="#" class="dropdown-toggle" data-hover="dropdown" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">2.x <i class="fa fa-menu-en fa-chevron-down"></i></a>
											<ul class="dropdown-menu">
												<li><a href="http://book.cakephp.org/3.0/zh">3.x Book</a></li>
												<li><a href="http://book.cakephp.org/2.0/zh">2.x Book</a></li>
												<li><a href="http://book.cakephp.org/1.3/zh/">1.3 Book</a></li>
												<li><a href="http://book.cakephp.org/1.2/zh/">1.2 Book</a></li>
												<li><a href="http://book.cakephp.org/1.1/en">1.1 Book</a></li>
											</ul>
										</li>
									</ul>
								</div>
							</div>
						</div>

					</div>
				</div>
			</div>
		</section>
	</header>

	
	<section class="nav-btn visible-sm visible-xs">
		<div class="container">
			<div class="row">
				<div class="col-sm-6 col-xs-6 text-center">
					<button id="btn-nav" class="btn btn-b btn-nav" data-toggle="modal" data-target="#modal"><strong>Nav</strong></button>
				</div>

				<div class="col-sm-6 col-xs-6 text-center">
					<button id="btn-toc" class="btn btn-b btn-nav" data-toggle="modal" data-target="#modal"><strong>Table of Contents</strong></button>
				</div>
			</div>
		</div>
	</section>

	
	<div id="modal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="modal-header">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
					<h4 class="modal-title-cookbook" id="modal-header"></h4>
				</div>
				<div class="modal-body"></div>
			</div>
		</div>
	</div>

<div class="container page-container"><div id="improve-slideout">
		<i class="fa fa-pencil icon-improve"></i>
		<a href="https://github.com/cakephp/docs/edit/master/zh/development/dispatch-filters.rst" target="_blank">
			<div id="improve-slideout-inner"><h6>Improve This Doc <i class="fa fa-github git-improve"></i></h6></div>
		</a>
	</div><a id="back-to-contents" href="#page-contents"><i class="fa fa-arrow-circle-up icon-improve" title="Back to Contents"></i></a>

	
	<div class="row">
		<div class="col-sm-12 col-md-9 col-md-push-3 space-left push-off"><div class="page-contents col-sm-5">
				<h3>Page Contents</h3>
				<ul>
<li><a class="reference internal" href="#">调度器过滤器</a><ul>
<li><a class="reference internal" href="#id2">配置过滤器</a></li>
<li><a class="reference internal" href="#id3">过滤器类</a></li>
<li><a class="reference internal" href="#id4">内嵌过滤器</a></li>
</ul>
</li>
</ul>

			</div><div class="document-body">
			
  <div class="section" id="id1">
<h1>调度器过滤器<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h1>
<div class="versionadded">
<p><span class="versionmodified">2.2 新版功能.</span></p>
</div>
<p>要一段代码在任何控制器代码执行之前或者在响应即将被发送往客户端之前运行，有若干种原因，
例如响应的缓存、标头(<em>header</em>)的调整、特殊的用户验证，或者只是要在比完整请求调度周期
更短的时间内提供对关键任务 API 响应的访问。</p>
<p>CakePHP 为这些情况提供了清晰和可扩展的接口，在调度周期中附加过滤器，类似于为每个请求
提供可堆叠的服务或者例程的中间件层。我们把这些叫做 <cite>调度器过滤器(Dispatcher Filters)</cite>。</p>
<div class="section" id="id2">
<h2>配置过滤器<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h2>
<p>过滤器通常在 <code class="docutils literal"><span class="pre">bootstrap.php</span></code> 文件中配置，但你可以在请求被调度之前从任何其它配置
文件容易地加载它们。添加或去除过滤器通过 <cite>Configure</cite> 类进行，使用特殊的键
<code class="docutils literal"><span class="pre">Dispatcher.filters</span></code>。默认情况下 CakePHP 自带的一些过滤器类已经对所有请求启用，让
我们看看它们是怎么添加的:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nx">Configure</span><span class="o">::</span><span class="na">write</span><span class="p">(</span><span class="s1">&#39;Dispatcher.filters&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">&#39;AssetDispatcher&#39;</span><span class="p">,</span>
    <span class="s1">&#39;CacheDispatcher&#39;</span>
<span class="p">));</span>
</pre></div>
</div>
<p>每个数组值是类名，类会被实例化，添加作为在调度器级别产生的事件的监听器(<em>listener</em>)。
第一个，<code class="docutils literal"><span class="pre">AssetDispatcher</span></code> 类用来检查请求是否指向一个主题(<em>theme</em>)或插件(<em>plugin</em>)
的资源文件，比如保存在插件的 webroot 目录或者主题的相应目录中的 CSS、JavaScript 或
图像。如果文件存在，它会提供相应的文件，停止其余的调度周期。<code class="docutils literal"><span class="pre">CacheDispatcher</span></code>
过滤器，当 <code class="docutils literal"><span class="pre">Cache.check</span></code> 配置变量为启用时，会检查响应是否已经在文件系统中对类似的
请求进行了缓存，并立即提供缓存的代码。</p>
<p>如你所见，自带的两个过滤器都负责停止进一步代码的执行，立即发送响应到客户端。但过滤器
并不仅限于这样的角色，如我们在本节即将展示的。</p>
<p>你可以在过滤器列表中加入自己的类名，它们会以定义的顺序执行。也有另外一种方法来附加不
涉及特殊的 <code class="docutils literal"><span class="pre">DispatcherFilter</span></code> 类的过滤器:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nx">Configure</span><span class="o">::</span><span class="na">write</span><span class="p">(</span><span class="s1">&#39;Dispatcher.filters&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">&#39;my-filter&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">&#39;callable&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="nv">$classInstance</span><span class="p">,</span> <span class="s1">&#39;methodName&#39;</span><span class="p">),</span>
        <span class="s1">&#39;on&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;after&#39;</span>
    <span class="p">)</span>
<span class="p">));</span>
</pre></div>
</div>
<p>如上所述，你可以传入任何合法的 PHP <a class="reference external" href="http://php.net/callback">回调(*callback*)</a>
类型，也许你还记得，<cite>回调</cite> 是任何 PHP 可以用 <code class="docutils literal"><span class="pre">call_user_func</span></code> 函数执行的东西。
我们做了一点例外，如果提供了字符串，这将被作为类名对待，而不是可能的函数名。这当然让
PHP 5.3 的用户可以附加匿名函数作为过滤器:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nx">Configure</span><span class="o">::</span><span class="na">write</span><span class="p">(</span><span class="s1">&#39;Dispatcher.filters&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
   <span class="s1">&#39;my-filter&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;callable&#39;</span> <span class="o">=&gt;</span> <span class="k">function</span><span class="p">(</span><span class="nv">$event</span><span class="p">)</span> <span class="p">{</span><span class="o">...</span><span class="p">},</span> <span class="s1">&#39;on&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;before&#39;</span><span class="p">),</span>
   <span class="c1">//更多过滤器</span>
<span class="p">));</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">on</span></code> 键只接受 <code class="docutils literal"><span class="pre">before</span></code> 和 <code class="docutils literal"><span class="pre">after</span></code> 为合法值，很明显，这意味着过滤器应当在
控制器代码执行之前或之后运行。除了用 <code class="docutils literal"><span class="pre">callable</span></code> 键定义过滤器，你也可以为过滤器定义
优先级，如果未指定，就使用默认值 <code class="docutils literal"><span class="pre">10</span></code>。</p>
<p>既然所有过滤器都具有优先级 <code class="docutils literal"><span class="pre">10</span></code>，如果你要某个过滤器在列表中的任何其它过滤器之前运行，
就可以根据需要选择较低的优先级数:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nx">Configure</span><span class="o">::</span><span class="na">write</span><span class="p">(</span><span class="s1">&#39;Dispatcher.filters&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
   <span class="s1">&#39;my-filter&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">&#39;callable&#39;</span> <span class="o">=&gt;</span> <span class="k">function</span><span class="p">(</span><span class="nv">$event</span><span class="p">)</span> <span class="p">{</span><span class="o">...</span><span class="p">},</span>
        <span class="s1">&#39;on&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;before&#39;</span><span class="p">,</span>
        <span class="s1">&#39;priority&#39;</span> <span class="o">=&gt;</span> <span class="mi">5</span>
    <span class="p">),</span>
    <span class="s1">&#39;other-filter&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">&#39;callable&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="nv">$class</span><span class="p">,</span> <span class="s1">&#39;method&#39;</span><span class="p">),</span>
        <span class="s1">&#39;on&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;after&#39;</span><span class="p">,</span>
        <span class="s1">&#39;priority&#39;</span> <span class="o">=&gt;</span> <span class="mi">1</span>
    <span class="p">),</span>
   <span class="c1">//更多过滤器</span>
<span class="p">));</span>
</pre></div>
</div>
<p>显然，在定义优先级时，过滤器声明的顺序，除了对相同优先级的过滤器，没有关系。在以类名
定义过滤器时，无法同时定义优先级，我们很快就会谈及这点。最后，CakePHP 的插件语法可以
用于定义位于插件内的过滤器:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nx">Configure</span><span class="o">::</span><span class="na">write</span><span class="p">(</span><span class="s1">&#39;Dispatcher.filters&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">&#39;MyPlugin.MyFilter&#39;</span><span class="p">,</span>
<span class="p">));</span>
</pre></div>
</div>
<p>只管移除默认附加的过滤器，如果你选择使用更高级/快速的方法来提供主题和插件的资源，或者
你不愿使用内置的完整页面缓存，或者只是要实现你自己的过滤器。</p>
<p>如果你需要传递构造函数参数或设置给你的调度过滤器类，你可以通过提供设置数组来这么做:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nx">Configure</span><span class="o">::</span><span class="na">write</span><span class="p">(</span><span class="s1">&#39;Dispatcher.filters&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">&#39;MyAssetFilter&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;service&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;google.com&#39;</span><span class="p">)</span>
<span class="p">));</span>
</pre></div>
</div>
<p>当过滤器键是一个合法的类名时，值可以是传递给调度过滤器的参数数组。默认情况下，基类会
在把这些设置与类的默认值合并后，赋值给 <code class="docutils literal"><span class="pre">$settings</span></code> 属性。</p>
<div class="versionchanged">
<p><span class="versionmodified">在 2.5 版更改: </span>在 2.5 版本中，你可以为调度过滤器提供构造函数设置。</p>
</div>
</div>
<div class="section" id="id3">
<h2>过滤器类<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h2>
<p>调度器过滤器，在配置中以类名定义时，应当扩展在 CakePHP 的 <cite>Routing</cite> 目录中提供的类
<code class="docutils literal"><span class="pre">DispatcherFilter</span></code> 。让我们来创建一个简单的过滤器，对特殊网址作出 &#8216;Hello World&#8217;
文字的响应:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nx">App</span><span class="o">::</span><span class="na">uses</span><span class="p">(</span><span class="s1">&#39;DispatcherFilter&#39;</span><span class="p">,</span> <span class="s1">&#39;Routing&#39;</span><span class="p">);</span>
<span class="k">class</span> <span class="nc">HelloWorldFilter</span> <span class="k">extends</span> <span class="nx">DispatcherFilter</span> <span class="p">{</span>

    <span class="k">public</span> <span class="nv">$priority</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">beforeDispatch</span><span class="p">(</span><span class="nx">CakeEvent</span> <span class="nv">$event</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$request</span> <span class="o">=</span> <span class="nv">$event</span><span class="o">-&gt;</span><span class="na">data</span><span class="p">[</span><span class="s1">&#39;request&#39;</span><span class="p">];</span>
        <span class="nv">$response</span> <span class="o">=</span> <span class="nv">$event</span><span class="o">-&gt;</span><span class="na">data</span><span class="p">[</span><span class="s1">&#39;response&#39;</span><span class="p">];</span>

        <span class="k">if</span> <span class="p">(</span><span class="nv">$request</span><span class="o">-&gt;</span><span class="na">url</span> <span class="o">===</span> <span class="s1">&#39;hello-world&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$response</span><span class="o">-&gt;</span><span class="na">body</span><span class="p">(</span><span class="s1">&#39;Hello World&#39;</span><span class="p">);</span>
            <span class="nv">$event</span><span class="o">-&gt;</span><span class="na">stopPropagation</span><span class="p">();</span>
            <span class="k">return</span> <span class="nv">$response</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>该类应当保存于文件 <code class="docutils literal"><span class="pre">app/Routing/Filter/HelloWorldFilter.php</span></code> 中，并在启动引导
(<em>bootstrap</em>)文件中按照前一节中的说明进行配置。这里有很多需要解释，让我们先从
<code class="docutils literal"><span class="pre">$priority</span></code> 的值开始。</p>
<p>如前所述，在使用过滤器类时你只能用类的 <code class="docutils literal"><span class="pre">$priority</span></code> 属性定义过滤器运行的顺序，如果
声明了属性其默认值为 10，这意味着它会在 Router 类解析了请求_之后_执行。在前面的例子
中我们不希望这样，因为很有可能你没有设置任何控制器来应答那个网址，所以我们选择 9 作为
我们的优先级。</p>
<p><code class="docutils literal"><span class="pre">DispatcherFilter</span></code> 类提供了两个方法，可以在子类中重载，即 <code class="docutils literal"><span class="pre">beforeDispatch</span></code> 和
<code class="docutils literal"><span class="pre">afterDispatch</span></code> 方法，它们分别在任何控制器执行之前或之后执行。两个方法都接受一个
<code class="xref php php-class docutils literal"><span class="pre">CakeEvent</span></code> 对象，它含有 <code class="docutils literal"><span class="pre">request</span></code> 和 <code class="docutils literal"><span class="pre">response</span></code> 对象(
<a class="reference internal" href="../controllers/request-response.html#CakeRequest" title="CakeRequest"><code class="xref php php-class docutils literal"><span class="pre">CakeRequest</span></code></a> 和 <a class="reference internal" href="../controllers/request-response.html#CakeResponse" title="CakeResponse"><code class="xref php php-class docutils literal"><span class="pre">CakeResponse</span></code></a> 实例)，以及在 <code class="docutils literal"><span class="pre">data</span></code> 属性
中的 <code class="docutils literal"><span class="pre">additionalParams</span></code> 数组。后者包含的信息用于调用 <code class="docutils literal"><span class="pre">requestAction</span></code> 方法时的
内部调度。</p>
<p>在我们的例子中，我们有条件地返回 <code class="docutils literal"><span class="pre">$response</span></code> 对象作为结果，这会告诉调度器不要
实例化任何控制器，并把该对象作为响应立即返回给客户端。我们也添加了
<code class="docutils literal"><span class="pre">$event-&gt;stopPropagation()</span></code> 来防止在该过滤器之后运行其它过滤器。</p>
<p>现在让我们再创建一个过滤器，来改变任何公开页面的响应标头(<em>header</em>)，在我们的具体情况
下这就是任何从 <code class="docutils literal"><span class="pre">PagesController</span></code> 控制器响应的东西:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nx">App</span><span class="o">::</span><span class="na">uses</span><span class="p">(</span><span class="s1">&#39;DispatcherFilter&#39;</span><span class="p">,</span> <span class="s1">&#39;Routing&#39;</span><span class="p">);</span>
<span class="k">class</span> <span class="nc">HttpCacheFilter</span> <span class="k">extends</span> <span class="nx">DispatcherFilter</span> <span class="p">{</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">afterDispatch</span><span class="p">(</span><span class="nx">CakeEvent</span> <span class="nv">$event</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$request</span> <span class="o">=</span> <span class="nv">$event</span><span class="o">-&gt;</span><span class="na">data</span><span class="p">[</span><span class="s1">&#39;request&#39;</span><span class="p">];</span>
        <span class="nv">$response</span> <span class="o">=</span> <span class="nv">$event</span><span class="o">-&gt;</span><span class="na">data</span><span class="p">[</span><span class="s1">&#39;response&#39;</span><span class="p">];</span>

        <span class="k">if</span> <span class="p">(</span><span class="nv">$request</span><span class="o">-&gt;</span><span class="na">params</span><span class="p">[</span><span class="s1">&#39;controller&#39;</span><span class="p">]</span> <span class="o">!==</span> <span class="s1">&#39;pages&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$response</span><span class="o">-&gt;</span><span class="na">statusCode</span><span class="p">()</span> <span class="o">===</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$response</span><span class="o">-&gt;</span><span class="na">sharable</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
            <span class="nv">$response</span><span class="o">-&gt;</span><span class="na">expires</span><span class="p">(</span><span class="nb">strtotime</span><span class="p">(</span><span class="s1">&#39;+1 day&#39;</span><span class="p">));</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>该过滤器会为 pages 控制器生成的所有相应发送一个将来 1 天的过期标头(<em>expiration
header</em>)。你当然可以在控制器中这么做，这只是用过滤器能够做什么的一个例子。例如，除了
改变响应，你可以用 <a class="reference internal" href="../core-libraries/caching.html#Cache" title="Cache"><code class="xref php php-class docutils literal"><span class="pre">Cache</span></code></a> 类缓存响应，并在 <code class="docutils literal"><span class="pre">beforeDispatch</span></code> 回调中
提供该响应。</p>
</div>
<div class="section" id="id4">
<h2>内嵌过滤器<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h2>
<p>我们的最后一个例子会使用匿名函数(只适用于 PHP 5.3+)来提供 JSON 格式的文章列表，我们
鼓励你用控制器和 <a class="reference internal" href="../views/json-and-xml-views.html#JsonView" title="JsonView"><code class="xref php php-class docutils literal"><span class="pre">JsonView</span></code></a> 类来达成此目的，不过让我们假设你需要为这个
关键任务的 API 端点节省几毫秒:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span></span><span class="nv">$postsList</span> <span class="o">=</span> <span class="k">function</span><span class="p">(</span><span class="nv">$event</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$event</span><span class="o">-&gt;</span><span class="na">data</span><span class="p">[</span><span class="s1">&#39;request&#39;</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">url</span> <span class="o">!==</span> <span class="s1">&#39;posts/recent.json&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">App</span><span class="o">::</span><span class="na">uses</span><span class="p">(</span><span class="s1">&#39;ClassRegistry&#39;</span><span class="p">,</span> <span class="s1">&#39;Utility&#39;</span><span class="p">);</span>
    <span class="nv">$postModel</span> <span class="o">=</span> <span class="nx">ClassRegistry</span><span class="o">::</span><span class="na">init</span><span class="p">(</span><span class="s1">&#39;Post&#39;</span><span class="p">);</span>
    <span class="nv">$event</span><span class="o">-&gt;</span><span class="na">data</span><span class="p">[</span><span class="s1">&#39;response&#39;</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">body</span><span class="p">(</span><span class="nb">json_encode</span><span class="p">(</span><span class="nv">$postModel</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="s1">&#39;recent&#39;</span><span class="p">)));</span>
    <span class="nv">$event</span><span class="o">-&gt;</span><span class="na">stopPropagation</span><span class="p">();</span>
    <span class="k">return</span> <span class="nv">$event</span><span class="o">-&gt;</span><span class="na">data</span><span class="p">[</span><span class="s1">&#39;response&#39;</span><span class="p">];</span>
<span class="p">};</span>

<span class="nx">Configure</span><span class="o">::</span><span class="na">write</span><span class="p">(</span><span class="s1">&#39;Dispatcher.filters&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">&#39;AssetDispatcher&#39;</span><span class="p">,</span>
    <span class="s1">&#39;CacheDispatcher&#39;</span><span class="p">,</span>
    <span class="s1">&#39;recent-posts&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">&#39;callable&#39;</span> <span class="o">=&gt;</span> <span class="nv">$postsList</span><span class="p">,</span>
        <span class="s1">&#39;priority&#39;</span> <span class="o">=&gt;</span> <span class="mi">9</span><span class="p">,</span>
        <span class="s1">&#39;on&#39;</span><span class="o">=&gt;</span> <span class="s1">&#39;before&#39;</span>
    <span class="p">)</span>
<span class="p">));</span>
</pre></div>
</div>
<p>在这个例子中我们为过滤器选择了优先级 <code class="docutils literal"><span class="pre">9</span></code>，这样就可以跳过任何在自定义过滤器或者象
CakePHP 内部的路由系统这样的核心过滤器中的逻辑了。虽然并非必须，但是这说明了如果你要
针对某些请求尽可能去除多余的累赘，如何让重要代码抢先运行。</p>
<p>基于很明显的原因，这可能让你的应用程序很难维护。如果明智地运用，过滤器是极其强大的
工具，为应用程序中的每个网址添加响应处理并非是对它很好的运用。但是如果你有合理的原因
这么做，那么你就手握一个清晰的解决方案。请牢记，并非所有的东西都要是过滤器，
<cite>Controllers</cite> 和 <cite>Components</cite> 通常是为应用程序添加请求处理更恰当的选择。</p>
</div>
</div>


			</div>
		</div>

		
		<div class="col-md-3 col-md-pull-9 pull-off hidden-xs hidden-sm" lang="zh">
			<aside class="sidebar">
				<div class="mb30 row">
<div id="sidebar-navigation" class="hidden-xs">
	<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../index.html">欢迎</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">安装</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started.html">入门指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cakephp-overview.html">CakePHP 概述</a></li>
<li class="toctree-l1"><a class="reference internal" href="../controllers.html">控制器</a></li>
<li class="toctree-l1"><a class="reference internal" href="../views.html">视图</a></li>
<li class="toctree-l1"><a class="reference internal" href="../models.html">模型</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core-libraries.html">核心库</a></li>
<li class="toctree-l1"><a class="reference internal" href="../plugins.html">插件</a></li>
<li class="toctree-l1"><a class="reference internal" href="../console-and-shells.html">Shells，任务与命令行工具</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../development.html">开发</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="configuration.html">配置</a></li>
<li class="toctree-l2"><a class="reference internal" href="routing.html">路由</a></li>
<li class="toctree-l2"><a class="reference internal" href="sessions.html">会话</a></li>
<li class="toctree-l2"><a class="reference internal" href="exceptions.html">异常</a></li>
<li class="toctree-l2"><a class="reference internal" href="errors.html">错误处理</a></li>
<li class="toctree-l2"><a class="reference internal" href="debugging.html">调试</a></li>
<li class="toctree-l2"><a class="reference internal" href="testing.html">测试</a></li>
<li class="toctree-l2"><a class="reference internal" href="rest.html">REST</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">调度器过滤器</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../deployment.html">部署</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials-and-examples.html">教程 &amp; 实例</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing.html">贡献</a></li>
<li class="toctree-l1"><a class="reference internal" href="../appendices.html">Appendices</a></li>
</ul>

</div>

				</div>
			</aside>
			<aside class="sidebar">
				<div class="mb30 row">
				</div>
			</aside>
		</div>
	</div>
</div>

<section id="socials" class="back-3">
	<div class="container-fluid">
		<div class="row">
			<div class="col-xs-12 col-sm-12 col-md-4  social text-center">
				<div class="col-sm-3 col-xs-3">
					<div id="fb-root"></div>
						<script>(function(d, s, id) {
						  var js, fjs = d.getElementsByTagName(s)[0];
						  if (d.getElementById(id)) return;
						  js = d.createElement(s); js.id = id;
						  js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.5";
						  fjs.parentNode.insertBefore(js, fjs);
						}(document, 'script', 'facebook-jssdk'));
						</script>
						<div id="fb-root-face" class="fb-like" data-href="https://www.facebook.com/CakePHP/" data-layout="button_count" data-action="like" data-show-faces="true" data-share="false"></div>
				</div>

				<div class="col-sm-3 col-xs-3">
					<iframe src="https://ghbtns.com/github-btn.html?user=cakephp&amp;repo=cakephp&amp;type=star&amp;count=true&amp;size=small" frameborder="0" scrolling="0" width="120px" height="30px"></iframe>
				</div>

				<div class="col-sm-3 col-xs-3">
					<iframe src="https://ghbtns.com/github-btn.html?user=cakephp&amp;repo=cakephp&amp;type=fork&amp;count=true&amp;size=small" frameborder="0" scrolling="0" width="120px" height="30px"></iframe>
				</div>

				<div class="col-sm-3 col-xs-3">
					<a href="https://twitter.com/CakePHP" class="twitter-follow-button" data-show-count="false" data-show-screen-name="false">Follow @CakePHP</a>
					<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
				</div>
			</div>

			<div class="col-xs-12 col-sm-12 col-md-8 social-footer text-center ">
				<a href="#">发现翻译错误? 请在下面留言</a>
				<a href="https://github.com/blackpuppy/docs/wiki" target="_blank">我要加入翻译</a>
				<a href="https://twitter.com/cakephp" data-toggle="tooltip" title="Twitter"><i class="fa icon-social fa-twitter"></i>
				<a href="http://www.facebook.com/groups/cake.community" data-toggle="tooltip" title="Facebook"><i class="fa icon-social fa-facebook"></i></a>
				<a href="http://goo.gl/mSC0s" data-toggle="tooltip" title="Google Plus"><i class="fa icon-social  fa-google-plus"></i></a>
				<a href="http://www.youtube.com/user/CakePHP" data-toggle="tooltip" title="Youtube"><i class="fa icon-social fa-youtube-play"></i></a>
				<a href="https://github.com/cakephp" data-toggle="tooltip" title="Github"><i class="fa icon-social fa-git"></i></a>
				<a href="http://cakesf.herokuapp.com/" target="_blank" title="Slack" data-toggle="tooltip"><i class="fa fa-slack icon-social"></i></a>
				<a href="http://stackoverflow.com/tags/cakephp" data-toggle="tooltip" title="Stack Overflow"><i class="fa icon-social fa-stack-overflow"></i></a>
				<a href="http://webchat.freenode.net/?channels=cakephp" data-toggle="tooltip" title="IRC" class="icon-irc">#IRC</a>
			</div>
		</div>
	</div>
</section>

<footer id="footer" class="footer-wrapper">
	<div class="container">

		<div class="row col-p30">
			<div class="col-sm-12 col-md-3">
				<div class="footer-widget t-footer">
					<div class="col-md-12">
						<a href="https://www.openhub.net/p/cakephp">
							<img src="../_static/open-hub.png">
						</a>
						<div class="mt10">
							<a href="https://www.rackspace.com/">
								<img src="../_static/rackspace.png">
							</a>
						</div>
					</div>
				</div>
			</div>

			<div class="col-sm-12 col-md-9">
				<div class="col-md-3 col-sm-6 business-solution">
					<ul class="footer-menu">
						<li class="menu-title">
	<a href="http://cakephp.org/business-solutions"><i class="fa fa-menu-title fa-briefcase"></i>Business Solutions</a>
</li>
<li class="menu-title mt30">
	<a href="http://cakephp.org/showcase"><i class="fa fa-menu-title fa-desktop"></i>Showcase</a>
</li>
					</ul>
				</div>

				<div class="col-md-3 col-sm-6">
					<ul class="footer-menu">
						
<li class="menu-title">
	<i class="fa fa-menu-title fa-book"></i>Documentation
</li>

<li><a href="http://book.cakephp.org"><i class="fa fa-menu fa-chevron-right"></i>CookBook</a></li>
<li><a href="http://api.cakephp.org"><i class="fa fa-menu fa-chevron-right"></i>API</a></li>

<li><a href="http://cakephp.org/documentation/videos"><i class="fa fa-menu fa-chevron-right"></i>Videos</a></li>
<li><a href="http://cakephp.org/privacy"><i class="fa fa-menu fa-chevron-right"></i>Privacy Policy</a></li>
<li><a href="http://cakephp.org/pages/trademark"><i class="fa fa-menu fa-chevron-right"></i>Logos &amp; Trademarks</a></li>
					</ul>
				</div>

				<div class="col-md-3 col-sm-6">
					<ul class="footer-menu">
						
<li class="menu-title"><i class="fa fa-menu-title fa-users"></i>Community</li>

<li><a href="http://cakephp.org/team"><i class="fa fa-menu fa-chevron-right"></i>Team</a></li>
<li><a href="https://github.com/cakephp/cakephp/issues"><i class="fa fa-menu fa-chevron-right"></i>Issues (Github)</a></li>
<li><a href="http://www.youtube.com/user/CakePHP"><i class="fa fa-menu fa-chevron-right"></i>YouTube Channel</a></li>
<li><a href="http://cakephp.org/get-involved"><i class="fa fa-menu fa-chevron-right"></i>Get Involved</a></li>

<li><a href="http://bakery.cakephp.org"><i class="fa fa-menu fa-chevron-right"></i>Bakery</a></li>
<li><a href="http://cakephp.org/newsletter/signup"><i class="fa fa-menu fa-chevron-right"></i>Newsletter</a></li>
<li><a href="http://certification.cakephp.org"><i class="fa fa-menu fa-chevron-right"></i>Certification</a></li>
<li><a href="http://my.cakephp.org"><i class="fa fa-menu fa-chevron-right"></i>My CakePHP</a></li>
<li><a href="http://cakefest.org"><i class="fa fa-menu fa-chevron-right"></i>CakeFest</a></li>
<li><a href="http://www.facebook.com/groups/cake.community"><i class="fa fa-menu fa-chevron-right"></i>Facebook</a></li>
<li><a href="http://twitter.com/cakephp"><i class="fa fa-menu fa-chevron-right"></i>Twitter</a></li>
					</ul>
				</div>

				<div class="col-md-3 col-sm-6">
					<ul class="footer-menu">
						
<li class="menu-title"><i class="fa fa-menu-title fa-comments-o"></i>Help &amp; Support</li>

<li><a href="http://discourse.cakephp.org"><i class="fa fa-menu fa-chevron-right"></i>Forum</a></li>
<li><a href="http://stackoverflow.com/tags/cakephp"><i class="fa fa-menu fa-chevron-right"></i>Stack Overflow</a></li>
<li><a href="http://webchat.freenode.net/?channels=cakephp"><i class="fa fa-menu fa-chevron-right"></i>IRC</a></li>
<li><a href="http://cakesf.herokuapp.com/"><i class="fa fa-menu fa-chevron-right"></i>Slack</a></li>
<li><a href="http://cakedc.com"><i class="fa fa-menu fa-chevron-right"></i>Paid Support</a></li>
					</ul>
				</div>
			</div>
		</div>

		<div class="row">
			<div class="col-md-12 text-center mt30">
				<p class="copyright">
							&copy; 版权所有 2016, Cake Software Foundation, Inc.
						最后更新于 8月 04, 2016.
						Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.4.5.
				</p>
			</div>
		</div>
	</div>
</footer>

<div id="inline-search-results"></div>


</div>

<script type="text/javascript">
	var _gaq = _gaq || [];
	_gaq.push(['_setAccount', 'UA-743287-3']);
	_gaq.push(['_trackPageview']);
	(function() {
		var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
		ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
		var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
	})();
</script>

<script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F201cbc61deaf9f7ffb521fb23e83db40' type='text/javascript'%3E%3C/script%3E"));
</script>

<!-- Duoshuo Comment BEGIN -->
	<div class="ds-thread"></div>
<script type="text/javascript">
var duoshuoQuery = {short_name:"cakephpchina"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = 'http://static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0]
		|| document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
<!-- Duoshuo Comment END -->
  </body>
</html>