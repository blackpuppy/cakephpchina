
<!DOCTYPE html>



<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta content="Authentication" lang="zh_CN" name="title" />
<meta content="authentication handlers,array php,basic authentication,web application,different ways,credentials,exceptions,cakephp,logging" lang="zh_CN" name="keywords" />

    <title>Authentication 认证 &mdash; CakePHP Cookbook 2.x 文档</title>
    
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '2.x',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/translations.js"></script>
    <script type="text/javascript" src="../../_static/app.js"></script>
    <script type="text/javascript" src="../../_static/modernizr.foundation.js"></script>
    <script type="text/javascript" src="../../_static/foundation.js"></script>
    <link rel="top" title="CakePHP Cookbook 2.x 文档" href="../../index.html" />
    <link rel="up" title="组件" href="../toc-components.html" />
    <link rel="next" title="Form tampering prevention" href="security-component.html" />
    <link rel="prev" title="Sessions" href="sessions.html" />
<link href="../../_static/favicon.ico" type="image/x-icon" rel="icon" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<link rel="alternate" hreflang="en" href="../../../en/core-libraries/components/authentication.html" /><link rel="alternate" hreflang="pt" href="../../../pt/core-libraries/components/authentication.html" /><link rel="alternate" hreflang="es" href="../../../es/core-libraries/components/authentication.html" /><link rel="alternate" hreflang="ja" href="../../../ja/core-libraries/components/authentication.html" /><link rel="alternate" hreflang="fr" href="../../../fr/core-libraries/components/authentication.html" />

<link rel="search" type="application/opensearchdescription+xml" title="CakePHP Book 2.x Search" href="../../_static/opensearchdescription-book-2-x.xml">
<script type="text/javascript">
window.lang = "zh_CN";
</script>

  </head>
  <body>

<div id="container">

<div id="cakephp-global-navigation">
	<ul>
		<li class="main"><a href="http://cakephp.org">CakePHP</a></li>
		<li class="primary"><a href="#" class="empty">Downloads</a>
			<ul class="second-level">
				<li><a href="https://github.com/cakephp/cakephp/tags">Releases</a></li>
				<li><a href="http://pear.cakephp.org">Pear channel</a></li>
			</ul>
		</li>
		<li class="primary"><a href="#" class="empty">Documentation</a>
			<ul class="second-level">
				<li><a href="http://api.cakephp.org">API</a></li>
				<li><a href="http://book.cakephp.org">Book</a></li>
			</ul>
		</li>
		<li class="primary"><a href="http://community.cakephp.org">Community</a>
			<ul class="second-level">
				<li><a href="http://webchat.freenode.net/?channels=cakephp&uio=MT1mYWxzZSY5PXRydWUmMTE9MjQ2b8">Help &amp; Support</a></li>
				<li><a href="https://github.com/cakephp/cakephp/issues">Issues</a></li>
				<li><a href="http://bakery.cakephp.org">The Bakery</a></li>
				<li><a href="http://stackoverflow.com/tags/cakephp">Stack Overflow</a></li>
				<li><a href="http://www.facebook.com/groups/cake.community">Facebook Group</a></li>
				<li><a href="http://goo.gl/mSC0s">Google+ Community</a></li>
				<li><a href="http://www.youtube.com/user/CakePHP">YouTube Channel</a></li>
				<li><a href="http://podcast.cakephp.org">CakePHP Podcast</a></li>
				<li><a href="http://twitter.com/CakePHP">Follow us on Twitter</a></li>
				<li><a href="http://groups.google.com/group/cake-php">Google Group</a></li>
				<li><a href="http://github.com/cakephp/cakephp/contributors">Contributors</a></li>
				<li><a href="http://plugins.cakephp.org">Plugins &amp; Packages</a></li>
				<li><a href="http://community.cakephp.org/get-involved">Get Involved</a></li>
				<li><a href="http://community.cakephp.org/guidelines">Guidelines</a></li>
				<li><a href="http://cakefest.org">CakeFest</a></li>
				<li><a href="http://cakephp.org/logos">Logo</a></li>
			</ul>
		</li>
		<li class="primary"><a href="http://cakephp.org/services">Services</a>
			<ul class="second-level">
				<li><a href="http://cakephp.org/services/certification">Certification</a></li>
				<li><a href="http://cakephp.org/services/consultation">Consultation</a></li>
				<li><a href="http://cakephp.org/services/support">Support</a></li>
				<li><a href="http://training.cakephp.org">Training</a></li>
			</ul>
		</li>
	</ul>
</div>

<div class="masthead">
	<div class="header-backing"></div>
	<div class="searchbar row">
		<div class="columns three phone-one">
			<a class="logo" href="../../contents.html">
			<img src="../../_static/cake-logo.png" alt="CakePHP" width="70" />
			</a>
		</div>
		
<div id="searchbox" class="columns nine phone-three">

	<form id="searchform" class="search" action="../../search.html" method="get">
		<input class="search-input" autocomplete="off" type="search" name="q" size="18" />
		<input class="search-submit search-big button red" type="submit" value="搜索" />
		<input type="hidden" name="check_keywords" value="yes" />
		<input type="hidden" name="area" value="default" />

		<a href="#" id="tablet-nav" class="show-on-phones pale button small">Nav</a>
	</form>

</div>
	</div>
</div>
<div class="breadcrumb-header">
	<div class="related row">
		<div class="columns three root-link">
			<a href="../../contents.html">Cookbook 2.x</a>
		</div>
		<div class="columns nine">
			<ul class="inline breadcrumb">
			<li itemscope itemtype="http://data-vocabulary.org/Breadcrumb">
				<a href="../../core-libraries.html"  itemprop="url"><span itemprop="title">核心库</span></a>
			</li>
			<li itemscope itemtype="http://data-vocabulary.org/Breadcrumb">
				<a href="../toc-components.html" accesskey="U" itemprop="url"><span itemprop="title">组件</span></a>
			</li>
			</ul>
			<div class="versions dropdown">
				<a href="#">2.x Book</a>
				<ul>
					<li><a href="http://book.cakephp.org/3.0/en">3.0 Book</a></li>
					<li><a href="http://book.cakephp.org/1.3/zh_CN/">1.3 Book</a></li>
					<li><a href="http://book.cakephp.org/1.2/zh_CN/">1.2 Book</a></li>
					<li><a href="http://book.cakephp.org/1.1/en">1.1 Book</a></li>
				</ul>
			</div>

			<div class="languages dropdown">
				<a href="#">zh_CN</a>

				<ul>
				
					<li><a href="../../../en/core-libraries/components/authentication.html">en</a></li>
				
					<li><a href="../../../pt/core-libraries/components/authentication.html">pt</a></li>
				
					<li><a href="../../../es/core-libraries/components/authentication.html">es</a></li>
				
					<li><a href="../../../ja/core-libraries/components/authentication.html">ja</a></li>
				
					<li><a href="../../../fr/core-libraries/components/authentication.html">fr</a></li>
				
					<li></li>
				
				</ul>
			</div>
		</div>
	</div>
</div>

<div class="content row">
	<div class="document columns nine push-three">
		<div class="body"><a class="button pale improve" href="https://github.com/cakephp/docs/edit/master/zh/core-libraries/components/authentication.rst" target="_blank">Improve this Doc</a>
  <div class="section" id="authentication">
<h1>Authentication 认证<a class="headerlink" href="#authentication" title="永久链接至标题">¶</a></h1>
<dl class="class">
<dt id="AuthComponent">
<em class="property">class </em><tt class="descname">AuthComponent</tt><big>(</big><em>ComponentCollection $collection</em>, <em>array $settings = array()</em><big>)</big><a class="headerlink" href="#AuthComponent" title="永久链接至目标">¶</a></dt>
<dd></dd></dl>

<p>标识、身份验证和授权用户几乎是每一个web应用程序中常见的部分。
CakePHP的AuthComponent(验证组件)提供了灵活的方式来完成这些任务。
CakePHP的AuthComponent允许结合验证对象,和授权对象来创建灵活的方式识别和检查用户授权。</p>
<p>Identifying, authenticating and authorizing users is a common part of
almost every web application.  In CakePHP AuthComponent provides a
pluggable way to do these tasks.  AuthComponent allows you to combine
authentication objects, and authorization objects to create flexible
ways of identifying and checking user authorization.</p>
<div class="section" id="authentication-objects">
<span id="id1"></span><h2>Authentication 认证<a class="headerlink" href="#authentication-objects" title="永久链接至标题">¶</a></h2>
<p>身份验证是一个通过提供凭证来识别用户的过程,确保用户说谁就是谁。
通常根据已知的用户列表对用户名和密码进行检查。在CakePHP,还有几个内建的
用户身份验证方式存储在应用程序中。</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">FormAuthenticate</span></tt> 表单认证。允许基于表单POST验证用户身份</li>
</ul>
<p>数据。通常是一个用户输入信息的登录表单。
* <tt class="docutils literal"><span class="pre">BasicAuthenticate</span></tt> 基本认证。使用基本的HTTP认证方式来验证用户。
* <tt class="docutils literal"><span class="pre">DigestAuthenticate</span></tt> 摘要认证。使用摘要HTTP认证方式来验证用户。</p>
<p>默认情况下 <tt class="docutils literal"><span class="pre">AuthComponent</span></tt> 使用 <tt class="docutils literal"><span class="pre">FormAuthenticate</span></tt> 。</p>
<p>Authentication is the process of identifying users by provided
credentials and ensuring that users are who they say they are.
Generally this is done through a username and password, that are checked
against a known list of users. In CakePHP, there are several built in
ways of authenticating users stored in your application.</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">FormAuthenticate</span></tt> allows you to authenticate users based on form POST
data.  Usually this is a login form that users enter information into.</li>
<li><tt class="docutils literal"><span class="pre">BasicAuthenticate</span></tt> allows you to authenticate users using Basic HTTP
authentication.</li>
<li><tt class="docutils literal"><span class="pre">DigestAuthenticate</span></tt> allows you to authenticate users using Digest
HTTP authentication.</li>
</ul>
<p>By default <tt class="docutils literal"><span class="pre">AuthComponent</span></tt> uses <tt class="docutils literal"><span class="pre">FormAuthenticate</span></tt>.</p>
<p>Choosing an Authentication type
选择一种认证方式
&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;-</p>
<p>通常你会想提供基于表单的身份验证。对于使用浏览器的用户来说最容易使用的。
如果您正在构建一个API或webservice(网络服务),可能要考虑基本身份验证或摘要身份验证。
摘要验证和基本身份验证方式的主要差异是对密码的处理。
基本身份验证中,用户名和密码作为纯文本到发送给服务器。这使得基本身份验证
不适合非SSL加密的应用程序,但是会暴露敏感密码。
摘要身份验证使用摘要散列的用户名、密码,和一些其他细节。这使得摘要式身份验证更适合
没有SSL加密的应用程序。</p>
<p>可以使用其他认证系统，像openid。但openid不属于CakePHP核心部分。</p>
<p>Generally you&#8217;ll want to offer form based authentication. It is the easiest for
users using a web-browser to use.  If you are building an API or webservice, you
may want to consider basic authentication or digest authentication.  The key
differences between digest and basic authentication are mostly related to how
passwords are handled.  In basic authentication, the username and password are
transmitted as plain-text to the server.  This makes basic authentication
un-suitable for applications without SSL, as you would end up exposing sensitive
passwords.  Digest authentication uses a digest hash of the username, password,
and a few other details.  This makes digest authentication more appropriate for
applications without SSL encryption.</p>
<p>You can also use authentication systems like openid as well, however openid is
not part of CakePHP core.</p>
<p>Configuring Authentication handlers
配置身份验证处理程序
&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8211;</p>
<p>使用``$this-&gt;Auth-&gt;authenticate``来配置身份验证处理程序。
可以为认证方式配置一个或多个处理程序。使用多个处理程序可支持用户以不同的方式登录。
用户在登录时,身份验证处理程序按顺序检查。一旦一个处理程序能够识别用户,
其他处理程序就不在检查。相反的,如果可以通过抛出异常停止所有的身份验证。
需要捕捉任何抛出的异常,并根据需要处理它们。</p>
<p>You configure authentication handlers using <tt class="docutils literal"><span class="pre">$this-&gt;Auth-&gt;authenticate</span></tt>.
You can configure one or many handlers for authentication.  Using
multiple handlers allows you to support different ways of logging users
in.  When logging users in, authentication handlers are checked in the
order they are declared.  Once one handler is able to identify the user,
no other handlers will be checked.  Conversely you can halt all
authentication by throwing an exception.  You will need to catch any
thrown exceptions, and handle them as needed.</p>
<p>在控制器的 <tt class="docutils literal"><span class="pre">beforeFilter</span></tt> 或 <tt class="docutils literal"><span class="pre">$components</span></tt> 数组中配置验证处理程序。
通过传入数组给每一个验证对象传递配置信息。</p>
<p>You can configure authentication handlers in your controller&#8217;s
<tt class="docutils literal"><span class="pre">beforeFilter</span></tt> or, in the <tt class="docutils literal"><span class="pre">$components</span></tt> array.  You can pass
configuration information into each authentication object, using an
array:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span class="c1">// Basic setup</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Auth</span><span class="o">-&gt;</span><span class="na">authenticate</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;Form&#39;</span><span class="p">);</span>

<span class="c1">// Pass settings in</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Auth</span><span class="o">-&gt;</span><span class="na">authenticate</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">&#39;Form&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;userModel&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Member&#39;</span><span class="p">),</span>
    <span class="s1">&#39;Basic&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;userModel&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Member&#39;</span><span class="p">)</span>
<span class="p">);</span>
</pre></div>
</div>
<p>第二个例子中你会注意到我们定义了 <tt class="docutils literal"><span class="pre">userModel</span></tt> 键名两次。为了保持DRY(不要重复自己)，
可以使用 <tt class="docutils literal"><span class="pre">all</span></tt> 键名，这个特殊的键名使得配置信息传递给每一个附带的对象。</p>
<p>In the second example you&#8217;ll notice that we had to declare the
<tt class="docutils literal"><span class="pre">userModel</span></tt> key twice. To help you keep your code DRY, you can use the
<tt class="docutils literal"><span class="pre">all</span></tt> key.  This special key allows you to set settings that are passed
to every attached object.  The all key is also exposed as
<tt class="docutils literal"><span class="pre">AuthComponent::ALL</span></tt>:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span class="c1">// Pass settings in using &#39;all&#39;</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Auth</span><span class="o">-&gt;</span><span class="na">authenticate</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
    <span class="nx">AuthComponent</span><span class="o">::</span><span class="na">ALL</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;userModel&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Member&#39;</span><span class="p">),</span>
    <span class="s1">&#39;Form&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Basic&#39;</span>
<span class="p">);</span>
</pre></div>
</div>
<p>上面的例子中，<tt class="docutils literal"><span class="pre">Form`</span> <span class="pre">`和</span> <span class="pre">``Basic</span></tt> 会使用&#8217;all&#8217;键名对应的配置信息。
传递给一个特定的认证对象的任何配置信息都会重写&#8217;all&#8217;键名中匹配的信息。
核心认证对象支持以下配置数组键名。</p>
<p>In the above example, both <tt class="docutils literal"><span class="pre">Form</span></tt> and <tt class="docutils literal"><span class="pre">Basic</span></tt> will get the settings
defined for the &#8216;all&#8217; key.  Any settings passed to a specific
authentication object will override the matching key in the &#8216;all&#8217; key.
The core authentication objects support the following configuration
keys.</p>
<ul>
<li><p class="first"><tt class="docutils literal"><span class="pre">fields</span></tt> The fields to use to identify a user by.</p>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">userModel</span></tt> The model name of the User, defaults to User.</p>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">scope</span></tt> Additional conditions to use when looking up and
authenticating users, i.e. <tt class="docutils literal"><span class="pre">array('User.is_active'</span> <span class="pre">=&gt;</span> <span class="pre">1).</span></tt></p>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">contain</span></tt> Containable options for when the user record is loaded.</p>
<div class="versionadded">
<p><span class="versionmodified">2.2 新版功能.</span></p>
</div>
</li>
</ul>
<p>To configure different fields for user in <tt class="docutils literal"><span class="pre">$components</span></tt> array:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span class="c1">// Pass settings in $components array</span>
<span class="k">public</span> <span class="nv">$components</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">&#39;Auth&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">&#39;authenticate&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
            <span class="s1">&#39;Form&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
                <span class="s1">&#39;fields&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;username&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;email&#39;</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="p">)</span>
<span class="p">);</span>
</pre></div>
</div>
<p>Do not put other Auth configuration keys (like authError, loginAction etc)
within the authenticate or Form element. They should be at the same level as
the authenticate key. The setup above with other Auth configuration
should look like:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span class="c1">// Pass settings in $components array</span>
<span class="k">public</span> <span class="nv">$components</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">&#39;Auth&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">&#39;loginAction&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
            <span class="s1">&#39;controller&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;users&#39;</span><span class="p">,</span>
            <span class="s1">&#39;action&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;login&#39;</span><span class="p">,</span>
            <span class="s1">&#39;plugin&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;users&#39;</span>
        <span class="p">),</span>
        <span class="s1">&#39;authError&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Did you really think you are allowed to see that?&#39;</span><span class="p">,</span>
        <span class="s1">&#39;authenticate&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
            <span class="s1">&#39;Form&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
                <span class="s1">&#39;fields&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;username&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;email&#39;</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="p">)</span>
<span class="p">);</span>
</pre></div>
</div>
<p>In addition to the common configuration, Basic authentication supports
the following keys:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">realm</span></tt> The realm being authenticated. Defaults to <tt class="docutils literal"><span class="pre">env('SERVER_NAME')</span></tt>.</li>
</ul>
<p>In addition to the common configuration Digest authentication supports
the following keys:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">realm</span></tt> The realm authentication is for, Defaults to the servername.</li>
<li><tt class="docutils literal"><span class="pre">nonce</span></tt> A nonce used for authentication.  Defaults to <tt class="docutils literal"><span class="pre">uniqid()</span></tt>.</li>
<li><tt class="docutils literal"><span class="pre">qop</span></tt> Defaults to auth, no other values are supported at this time.</li>
<li><tt class="docutils literal"><span class="pre">opaque</span></tt> A string that must be returned unchanged by clients. Defaults
to <tt class="docutils literal"><span class="pre">md5($settings['realm'])</span></tt></li>
</ul>
<div class="section" id="creating-custom-authentication-objects">
<h3>Creating Custom Authentication objects<a class="headerlink" href="#creating-custom-authentication-objects" title="永久链接至标题">¶</a></h3>
<p>Because authentication objects are pluggable, you can create custom
authentication objects in your application or plugins.  If for example
you wanted to create an OpenID authentication object.  In
<tt class="docutils literal"><span class="pre">app/Controller/Component/Auth/OpenidAuthenticate.php</span></tt> you could put
the following:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span class="nx">App</span><span class="o">::</span><span class="na">uses</span><span class="p">(</span><span class="s1">&#39;BaseAuthenticate&#39;</span><span class="p">,</span> <span class="s1">&#39;Controller/Component/Auth&#39;</span><span class="p">);</span>

<span class="k">class</span> <span class="nc">OpenidAuthenticate</span> <span class="k">extends</span> <span class="nx">BaseAuthenticate</span> <span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">authenticate</span><span class="p">(</span><span class="nx">CakeRequest</span> <span class="nv">$request</span><span class="p">,</span> <span class="nx">CakeResponse</span> <span class="nv">$response</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Do things for openid here.</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Authentication objects should return <tt class="docutils literal"><span class="pre">false</span></tt> if they cannot identify the
user.  And an array of user information if they can. It&#8217;s not required
that you extend <tt class="docutils literal"><span class="pre">BaseAuthenticate</span></tt>, only that your authentication object
implements an <tt class="docutils literal"><span class="pre">authenticate()</span></tt> method.  The <tt class="docutils literal"><span class="pre">BaseAuthenticate</span></tt> class
provides a number of helpful methods that are commonly used.  You can
also implement a <tt class="docutils literal"><span class="pre">getUser()</span></tt> method if your authentication object needs
to support stateless or cookie-less authentication. See the sections on
basic and digest authentication below for more information.</p>
</div>
<div class="section" id="using-custom-authentication-objects">
<h3>Using custom authentication objects<a class="headerlink" href="#using-custom-authentication-objects" title="永久链接至标题">¶</a></h3>
<p>Once you&#8217;ve created your custom authentication object, you can use them
by including them in AuthComponents authenticate array:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Auth</span><span class="o">-&gt;</span><span class="na">authenticate</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">&#39;Openid&#39;</span><span class="p">,</span> <span class="c1">// app authentication object.</span>
    <span class="s1">&#39;AuthBag.Combo&#39;</span><span class="p">,</span> <span class="c1">// plugin authentication object.</span>
<span class="p">);</span>
</pre></div>
</div>
<p>Identifying users and logging them in
识别用户登录
&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;-</p>
<p>In the past <tt class="docutils literal"><span class="pre">AuthComponent</span></tt> auto-magically logged users in.  This was
confusing for many people, and made using AuthComponent a bit difficult
at times.  For 2.0, you&#8217;ll need to manually call <tt class="docutils literal"><span class="pre">$this-&gt;Auth-&gt;login()</span></tt>
to log a user in.</p>
<p>When authenticating users, attached authentication objects are checked
in the order they are attached.  Once one of the objects can identify
the user, no other objects are checked.  A sample login function for
working with a login form could look like:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span class="k">public</span> <span class="k">function</span> <span class="nf">login</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">is</span><span class="p">(</span><span class="s1">&#39;post&#39;</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Auth</span><span class="o">-&gt;</span><span class="na">login</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Auth</span><span class="o">-&gt;</span><span class="na">redirectUrl</span><span class="p">());</span>
            <span class="c1">// Prior to 2.3 use `return $this-&gt;redirect($this-&gt;Auth-&gt;redirect());`</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Session</span><span class="o">-&gt;</span><span class="na">setFlash</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">&#39;Username or password is incorrect&#39;</span><span class="p">),</span> <span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(),</span> <span class="s1">&#39;auth&#39;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The above code (without any data passed to the <tt class="docutils literal"><span class="pre">login</span></tt> method), will attempt to log a user in using
the POST data, and if successful redirect the user to either the last page they were visiting,
or <a class="reference internal" href="#AuthComponent::$loginRedirect" title="AuthComponent::$loginRedirect"><tt class="xref php php-attr docutils literal"><span class="pre">AuthComponent::$loginRedirect</span></tt></a>.  If the login is unsuccessful, a flash message is set.</p>
<div class="admonition warning">
<p class="first admonition-title">警告</p>
<p class="last">In 2.0 <tt class="docutils literal"><span class="pre">$this-&gt;Auth-&gt;login($this-&gt;request-&gt;data)</span></tt> will log the user in with whatever data is posted,
whereas in 1.3 <tt class="docutils literal"><span class="pre">$this-&gt;Auth-&gt;login($this-&gt;data)</span></tt> would try to identify the user first and only log in
when successful.</p>
</div>
<div class="section" id="using-digest-and-basic-authentication-for-logging-in">
<h4>Using Digest and Basic Authentication for logging in<a class="headerlink" href="#using-digest-and-basic-authentication-for-logging-in" title="永久链接至标题">¶</a></h4>
<p>Because basic and digest authentication don&#8217;t require an initial POST to
be performed before they initiate the login sequence, your <tt class="docutils literal"><span class="pre">login()</span></tt>
function will look a bit different than when using
<tt class="docutils literal"><span class="pre">FormAuthentication</span></tt>:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span class="k">public</span> <span class="k">function</span> <span class="nf">login</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Auth</span><span class="o">-&gt;</span><span class="na">login</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Auth</span><span class="o">-&gt;</span><span class="na">redirectUrl</span><span class="p">());</span>
        <span class="c1">// Prior to 2.3 use `return $this-&gt;redirect($this-&gt;Auth-&gt;redirect());`</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Session</span><span class="o">-&gt;</span><span class="na">setFlash</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">&#39;Username or password is incorrect&#39;</span><span class="p">),</span> <span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(),</span> <span class="s1">&#39;auth&#39;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Once logged in, users using digest and basic auth are not required to
have cookies.  In fact, all authentication objects are able to provide
<em>stateless</em> authentication through implementing the <tt class="docutils literal"><span class="pre">getUser()</span></tt> method.
If the client supports cookies, basic and digest auth will store a user
in session much like any other authentication object.  If a client
doesn&#8217;t support cookies, (such as a simple HTTP client built on top of
CURL) stateless authentication is also supported.  Stateless
authentication will re-verify the user&#8217;s credentials on each request,
this creates a small amount of additional overhead, but allows clients
that cannot or do not support cookies to login in.</p>
</div>
</div>
<div class="section" id="creating-stateless-authentication-systems">
<h3>Creating stateless authentication systems<a class="headerlink" href="#creating-stateless-authentication-systems" title="永久链接至标题">¶</a></h3>
<p>Authentication objects can implement a <tt class="docutils literal"><span class="pre">getUser()</span></tt> method that can be
used to support user login systems that don&#8217;t rely on cookies.  A
typical getUser method looks at the request/environment and uses the
information there to confirm the identity of the user.  HTTP Basic
authentication for example uses <tt class="docutils literal"><span class="pre">$_SERVER['PHP_AUTH_USER']</span></tt> and
<tt class="docutils literal"><span class="pre">$_SERVER['PHP_AUTH_PW']</span></tt> for the username and password fields.  On each
request, if a client doesn&#8217;t support cookies, these values are used to
re-identify the user and ensure they are valid user.  As with
authentication object&#8217;s <tt class="docutils literal"><span class="pre">authenticate()</span></tt> method the <tt class="docutils literal"><span class="pre">getUser()</span></tt> method
should return an array of user information on success, and <tt class="docutils literal"><span class="pre">false</span></tt> on
failure.:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span class="k">public</span> <span class="k">function</span> <span class="nf">getUser</span><span class="p">(</span><span class="nv">$request</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$username</span> <span class="o">=</span> <span class="nx">env</span><span class="p">(</span><span class="s1">&#39;PHP_AUTH_USER&#39;</span><span class="p">);</span>
    <span class="nv">$pass</span> <span class="o">=</span> <span class="nx">env</span><span class="p">(</span><span class="s1">&#39;PHP_AUTH_PW&#39;</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$username</span><span class="p">)</span> <span class="o">||</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$pass</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_findUser</span><span class="p">(</span><span class="nv">$username</span><span class="p">,</span> <span class="nv">$pass</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The above is how you could implement getUser method for HTTP basic
authentication.  The <tt class="docutils literal"><span class="pre">_findUser()</span></tt> method is part of <tt class="docutils literal"><span class="pre">BaseAuthenticate</span></tt>
and identifies a user based on a username and password.</p>
</div>
<div class="section" id="displaying-auth-related-flash-messages">
<h3>Displaying auth related flash messages<a class="headerlink" href="#displaying-auth-related-flash-messages" title="永久链接至标题">¶</a></h3>
<p>In order to display the session error messages that Auth generates, you
need to add the following code to your layout. Add the following two
lines to the <tt class="docutils literal"><span class="pre">app/View/Layouts/default.ctp</span></tt> file in the body section
preferable before the content_for_layout line.:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span class="k">echo</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Session</span><span class="o">-&gt;</span><span class="na">flash</span><span class="p">();</span>
<span class="k">echo</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Session</span><span class="o">-&gt;</span><span class="na">flash</span><span class="p">(</span><span class="s1">&#39;auth&#39;</span><span class="p">);</span>
</pre></div>
</div>
<p>You can customize the error messages, and flash settings AuthComponent
uses.  Using <tt class="docutils literal"><span class="pre">$this-&gt;Auth-&gt;flash</span></tt> you can configure the parameters
AuthComponent uses for setting flash messages.  The available keys are</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">element</span></tt> - The element to use, defaults to &#8216;default&#8217;.</li>
<li><tt class="docutils literal"><span class="pre">key</span></tt> - The key to use, defaults to &#8216;auth&#8217;</li>
<li><tt class="docutils literal"><span class="pre">params</span></tt> - The array of additional params to use, defaults to array()</li>
</ul>
<p>In addition to the flash message settings you can customize other error
messages AuthComponent uses. In your controller&#8217;s beforeFilter, or
component settings you can use <tt class="docutils literal"><span class="pre">authError</span></tt> to customize the error used
for when authorization fails:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Auth</span><span class="o">-&gt;</span><span class="na">authError</span> <span class="o">=</span> <span class="s2">&quot;This error shows up with the user tries to access a part of the website that is protected.&quot;</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="hashing-passwords">
<h3>Hashing passwords<a class="headerlink" href="#hashing-passwords" title="永久链接至标题">¶</a></h3>
<p>AuthComponent no longer automatically hashes every password it can find.
This was removed because it made a number of common tasks like
validation difficult.  You should <strong>never</strong> store plain text passwords,
and before saving a user record you should always hash the password.
You can use the static <tt class="docutils literal"><span class="pre">AuthComponent::password()</span></tt> to hash passwords
before saving them.  This will use the configured hashing strategy for
your application.</p>
<p>After validating the password, you can hash a password in the beforeSave
callback of your model:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="k">extends</span> <span class="nx">AppModel</span> <span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">beforeSave</span><span class="p">(</span><span class="nv">$options</span> <span class="o">=</span> <span class="k">array</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">data</span><span class="p">[</span><span class="s1">&#39;User&#39;</span><span class="p">][</span><span class="s1">&#39;password&#39;</span><span class="p">]))</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">data</span><span class="p">[</span><span class="s1">&#39;User&#39;</span><span class="p">][</span><span class="s1">&#39;password&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">AuthComponent</span><span class="o">::</span><span class="na">password</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">data</span><span class="p">[</span><span class="s1">&#39;User&#39;</span><span class="p">][</span><span class="s1">&#39;password&#39;</span><span class="p">]);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>You don&#8217;t need to hash passwords before calling <tt class="docutils literal"><span class="pre">$this-&gt;Auth-&gt;login()</span></tt>.
The various authentication objects will hash passwords individually. If
you are using Digest authentication, you should not use
AuthComponent::password() for generating passwords.  See below for how
to generate digest hashes.</p>
<div class="section" id="hashing-passwords-for-digest-authentication">
<h4>Hashing passwords for digest authentication<a class="headerlink" href="#hashing-passwords-for-digest-authentication" title="永久链接至标题">¶</a></h4>
<p>Because Digest authentication requires a password hashed in the format
defined by the RFC, in order to correctly hash a password for use with
Digest authentication you should use the special password hashing
function on <tt class="docutils literal"><span class="pre">DigestAuthenticate</span></tt>.  If you are going to be combining
digest authentication with any other authentication strategies, it&#8217;s also
recommended that you store the digest password in a separate column,
from the normal password hash:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="k">extends</span> <span class="nx">AppModel</span> <span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">beforeSave</span><span class="p">(</span><span class="nv">$options</span> <span class="o">=</span> <span class="k">array</span><span class="p">())</span> <span class="p">{</span>
        <span class="c1">// make a password for digest auth.</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">data</span><span class="p">[</span><span class="s1">&#39;User&#39;</span><span class="p">][</span><span class="s1">&#39;digest_hash&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">DigestAuthenticate</span><span class="o">::</span><span class="na">password</span><span class="p">(</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">data</span><span class="p">[</span><span class="s1">&#39;User&#39;</span><span class="p">][</span><span class="s1">&#39;username&#39;</span><span class="p">],</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">data</span><span class="p">[</span><span class="s1">&#39;User&#39;</span><span class="p">][</span><span class="s1">&#39;password&#39;</span><span class="p">],</span> <span class="nx">env</span><span class="p">(</span><span class="s1">&#39;SERVER_NAME&#39;</span><span class="p">)</span>
        <span class="p">);</span>
        <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Passwords for digest authentication need a bit more information than
other password hashes, based on the RFC for digest authentication. If
you use AuthComponent::password() for digest hashes you will not be able
to login.</p>
<div class="admonition note">
<p class="first admonition-title">注解</p>
<p class="last">The third parameter of DigestAuthenticate::password() must match the
&#8216;realm&#8217; config value defined when DigestAuthentication was
configured in AuthComponent::$authenticate.  This defaults to
<tt class="docutils literal"><span class="pre">env('SCRIPT_NAME)</span></tt>.  You may wish to use a static string if you
want consistent hashes in multiple environments.</p>
</div>
</div>
</div>
<div class="section" id="using-bcrypt-for-passwords">
<h3>Using bcrypt for passwords<a class="headerlink" href="#using-bcrypt-for-passwords" title="永久链接至标题">¶</a></h3>
<div class="versionadded">
<p><span class="versionmodified">2.3 新版功能.</span></p>
</div>
<p>As of CakePHP 2.3.0 you can use <a class="reference external" href="https://en.wikipedia.org/wiki/Bcrypt">bcrypt</a>
a.k.a Blowfish to hash passwords. Bcrypt hashes are much harder to brute force
than passwords stored with sha1. Even though the default hashing strategy is
<tt class="docutils literal"><span class="pre">sha</span></tt> - for backwards compatibility reasons. It is recommended that new
applications use bcrypt for passwords. Bcrypt provides improved security.
reasons. To use bcrpyt you&#8217;ll need to enable the <tt class="docutils literal"><span class="pre">Blowfish</span></tt> authentication
adapter:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span class="k">public</span> <span class="nv">$components</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">&#39;Auth&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">&#39;authenticate&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
            <span class="s1">&#39;Blowfish&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
                <span class="s1">&#39;scope&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;User.is_active&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="p">)</span>
<span class="p">);</span>
</pre></div>
</div>
<p>Other than how passwords are hashed and stored <tt class="docutils literal"><span class="pre">BlowfishAuthenticate</span></tt> works
the same as <tt class="docutils literal"><span class="pre">FormAuthenticate</span></tt>, and supports all the same options. Instead of
using <a class="reference internal" href="#AuthComponent::password" title="AuthComponent::password"><tt class="xref php php-meth docutils literal"><span class="pre">AuthComponent::password()</span></tt></a> to generate password hashes you
should use the following:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span class="nx">App</span><span class="o">::</span><span class="na">uses</span><span class="p">(</span><span class="s1">&#39;Security&#39;</span><span class="p">,</span> <span class="s1">&#39;Utility&#39;</span><span class="p">);</span>
<span class="k">class</span> <span class="nc">User</span> <span class="k">extends</span> <span class="nx">AppModel</span> <span class="p">{</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">beforeSave</span><span class="p">(</span><span class="nv">$options</span> <span class="o">=</span> <span class="k">array</span><span class="p">())</span> <span class="p">{</span>
        <span class="c1">// Use bcrypt</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">data</span><span class="p">[</span><span class="s1">&#39;User&#39;</span><span class="p">][</span><span class="s1">&#39;password&#39;</span><span class="p">]))</span> <span class="p">{</span>
            <span class="nv">$hash</span> <span class="o">=</span> <span class="nx">Security</span><span class="o">::</span><span class="na">hash</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">data</span><span class="p">[</span><span class="s1">&#39;User&#39;</span><span class="p">][</span><span class="s1">&#39;password&#39;</span><span class="p">],</span> <span class="s1">&#39;blowfish&#39;</span><span class="p">);</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">data</span><span class="p">[</span><span class="s1">&#39;User&#39;</span><span class="p">][</span><span class="s1">&#39;password&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$hash</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="manually-logging-users-in">
<h3>Manually logging users in<a class="headerlink" href="#manually-logging-users-in" title="永久链接至标题">¶</a></h3>
<p>Sometimes the need arises where you need to manually log a user in, such
as just after they registered for your application.  You can do this by
calling <tt class="docutils literal"><span class="pre">$this-&gt;Auth-&gt;login()</span></tt> with the user data you want to &#8216;login&#8217;:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span class="k">public</span> <span class="k">function</span> <span class="nf">register</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">User</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">data</span><span class="p">))</span> <span class="p">{</span>
        <span class="nv">$id</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">User</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">data</span><span class="p">[</span><span class="s1">&#39;User&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">array_merge</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">data</span><span class="p">[</span><span class="s1">&#39;User&#39;</span><span class="p">],</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="nv">$id</span><span class="p">));</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Auth</span><span class="o">-&gt;</span><span class="na">login</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">data</span><span class="p">[</span><span class="s1">&#39;User&#39;</span><span class="p">]);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">redirect</span><span class="p">(</span><span class="s1">&#39;/users/home&#39;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">警告</p>
<p class="last">Be sure to manually add the new User id to the array passed to the login
method. Otherwise you won&#8217;t have the user id available.</p>
</div>
</div>
<div class="section" id="accessing-the-logged-in-user">
<h3>Accessing the logged in user<a class="headerlink" href="#accessing-the-logged-in-user" title="永久链接至标题">¶</a></h3>
<p>Once a user is logged in, you will often need some particular
information about the current user.  You can access the currently logged
in user using <tt class="docutils literal"><span class="pre">AuthComponent::user()</span></tt>.  This method is static, and can
be used globally after the AuthComponent has been loaded. You can access
it both as an instance method or as a static method:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span class="c1">// Use anywhere</span>
<span class="nx">AuthComponent</span><span class="o">::</span><span class="na">user</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>

<span class="c1">// From inside a controller</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Auth</span><span class="o">-&gt;</span><span class="na">user</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="logging-users-out">
<h3>Logging users out<a class="headerlink" href="#logging-users-out" title="永久链接至标题">¶</a></h3>
<p>Eventually you&#8217;ll want a quick way to de-authenticate someone, and
redirect them to where they need to go. This method is also useful if
you want to provide a &#8216;Log me out&#8217; link inside a members&#8217; area of your
application:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span class="k">public</span> <span class="k">function</span> <span class="nf">logout</span><span class="p">()</span> <span class="p">{</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Auth</span><span class="o">-&gt;</span><span class="na">logout</span><span class="p">());</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Logging out users that logged in with Digest or Basic auth is difficult
to accomplish for all clients.  Most browsers will retain credentials
for the duration they are still open.  Some clients can be forced to
logout by sending a 401 status code.  Changing the authentication realm
is another solution that works for some clients.</p>
</div>
</div>
<div class="section" id="authorization">
<span id="authorization-objects"></span><h2>Authorization<a class="headerlink" href="#authorization" title="永久链接至标题">¶</a></h2>
<p>Authorization is the process of ensuring that an
identified/authenticated user is allowed to access the resources they
are requesting.  If enabled <tt class="docutils literal"><span class="pre">AuthComponent</span></tt> can automatically check
authorization handlers and ensure that logged in users are allowed to
access the resources they are requesting.  There are several built-in
authorization handlers, and you can create custom ones for your
application, or as part of a plugin.</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">ActionsAuthorize</span></tt> Uses the AclComponent to check for permissions on
an action level.</li>
<li><tt class="docutils literal"><span class="pre">CrudAuthorize</span></tt> Uses the AclComponent and action -&gt; CRUD mappings to
check permissions for resources.</li>
<li><tt class="docutils literal"><span class="pre">ControllerAuthorize</span></tt> Calls <tt class="docutils literal"><span class="pre">isAuthorized()</span></tt> on the active controller,
and uses the return of that to authorize a user.  This is often the
most simple way to authorize users.</li>
</ul>
<div class="section" id="configuring-authorization-handlers">
<h3>Configuring Authorization handlers<a class="headerlink" href="#configuring-authorization-handlers" title="永久链接至标题">¶</a></h3>
<p>You configure authorization handlers using <tt class="docutils literal"><span class="pre">$this-&gt;Auth-&gt;authorize</span></tt>.
You can configure one or many handlers for authorization.  Using
multiple handlers allows you to support different ways of checking
authorization.  When authorization handlers are checked, they will be
called in the order they are declared.  Handlers should return false, if
they are unable to check authorization, or the check has failed.
Handlers should return true if they were able to check authorization
successfully. Handlers will be called in sequence until one passes.  If
all checks fail, the user will be redirected to the page they came from.
Additionally you can halt all authorization by throwing an exception.
You will need to catch any thrown exceptions, and handle them.</p>
<p>You can configure authorization handlers in your controller&#8217;s
<tt class="docutils literal"><span class="pre">beforeFilter</span></tt> or, in the <tt class="docutils literal"><span class="pre">$components</span></tt> array.  You can pass
configuration information into each authorization object, using an
array:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span class="c1">// Basic setup</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Auth</span><span class="o">-&gt;</span><span class="na">authorize</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;Controller&#39;</span><span class="p">);</span>

<span class="c1">// Pass settings in</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Auth</span><span class="o">-&gt;</span><span class="na">authorize</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">&#39;Actions&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;actionPath&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;controllers/&#39;</span><span class="p">),</span>
    <span class="s1">&#39;Controller&#39;</span>
<span class="p">);</span>
</pre></div>
</div>
<p>Much like <tt class="docutils literal"><span class="pre">Auth-&gt;authenticate</span></tt>, <tt class="docutils literal"><span class="pre">Auth-&gt;authorize</span></tt>, helps you
keep your code DRY, by using the <tt class="docutils literal"><span class="pre">all</span></tt> key. This special key allows you
to set settings that are passed to every attached object. The all key
is also exposed as <tt class="docutils literal"><span class="pre">AuthComponent::ALL</span></tt>:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span class="c1">// Pass settings in using &#39;all&#39;</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Auth</span><span class="o">-&gt;</span><span class="na">authorize</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
    <span class="nx">AuthComponent</span><span class="o">::</span><span class="na">ALL</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;actionPath&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;controllers/&#39;</span><span class="p">),</span>
    <span class="s1">&#39;Actions&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Controller&#39;</span>
<span class="p">);</span>
</pre></div>
</div>
<p>In the above example, both the <tt class="docutils literal"><span class="pre">Actions</span></tt> and <tt class="docutils literal"><span class="pre">Controller</span></tt> will get the
settings defined for the &#8216;all&#8217; key. Any settings passed to a specific
authorization object will override the matching key in the &#8216;all&#8217; key.
The core authorize objects support the following configuration keys.</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">actionPath</span></tt> Used by <tt class="docutils literal"><span class="pre">ActionsAuthorize</span></tt> to locate controller action
ACO&#8217;s in the ACO tree.</li>
<li><tt class="docutils literal"><span class="pre">actionMap</span></tt> Action -&gt; CRUD mappings.  Used by <tt class="docutils literal"><span class="pre">CrudAuthorize</span></tt> and
authorization objects that want to map actions to CRUD roles.</li>
<li><tt class="docutils literal"><span class="pre">userModel</span></tt> The name of the ARO/Model node user information can be found
under. Used with ActionsAuthorize.</li>
</ul>
</div>
<div class="section" id="creating-custom-authorize-objects">
<h3>Creating Custom Authorize objects<a class="headerlink" href="#creating-custom-authorize-objects" title="永久链接至标题">¶</a></h3>
<p>Because authorize objects are pluggable, you can create custom authorize
objects in your application or plugins. If for example you wanted to
create an LDAP authorize object. In
<tt class="docutils literal"><span class="pre">app/Controller/Component/Auth/LdapAuthorize.php</span></tt> you could put the
following:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span class="nx">App</span><span class="o">::</span><span class="na">uses</span><span class="p">(</span><span class="s1">&#39;BaseAuthorize&#39;</span><span class="p">,</span> <span class="s1">&#39;Controller/Component/Auth&#39;</span><span class="p">);</span>

<span class="k">class</span> <span class="nc">LdapAuthorize</span> <span class="k">extends</span> <span class="nx">BaseAuthorize</span> <span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">authorize</span><span class="p">(</span><span class="nv">$user</span><span class="p">,</span> <span class="nx">CakeRequest</span> <span class="nv">$request</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Do things for ldap here.</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Authorize objects should return <tt class="docutils literal"><span class="pre">false</span></tt> if the user is denied access, or
if the object is unable to perform a check.  If the object is able to
verify the user&#8217;s access, <tt class="docutils literal"><span class="pre">true</span></tt> should be returned. It&#8217;s not required
that you extend <tt class="docutils literal"><span class="pre">BaseAuthorize</span></tt>, only that your authorize object
implements an <tt class="docutils literal"><span class="pre">authorize()</span></tt> method.  The <tt class="docutils literal"><span class="pre">BaseAuthorize</span></tt> class provides
a number of helpful methods that are commonly used.</p>
<div class="section" id="using-custom-authorize-objects">
<h4>Using custom authorize objects<a class="headerlink" href="#using-custom-authorize-objects" title="永久链接至标题">¶</a></h4>
<p>Once you&#8217;ve created your custom authorize object, you can use them by
including them in your AuthComponent&#8217;s authorize array:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Auth</span><span class="o">-&gt;</span><span class="na">authorize</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">&#39;Ldap&#39;</span><span class="p">,</span> <span class="c1">// app authorize object.</span>
    <span class="s1">&#39;AuthBag.Combo&#39;</span><span class="p">,</span> <span class="c1">// plugin authorize object.</span>
<span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="using-no-authorization">
<h3>Using no authorization<a class="headerlink" href="#using-no-authorization" title="永久链接至标题">¶</a></h3>
<p>If you&#8217;d like to not use any of the built-in authorization objects, and
want to handle things entirely outside of AuthComponent you can set
<tt class="docutils literal"><span class="pre">$this-&gt;Auth-&gt;authorize</span> <span class="pre">=</span> <span class="pre">false;</span></tt>.  By default AuthComponent starts off
with <tt class="docutils literal"><span class="pre">authorize</span> <span class="pre">=</span> <span class="pre">false</span></tt>.  If you don&#8217;t use an authorization scheme,
make sure to check authorization yourself in your controller&#8217;s
beforeFilter, or with another component.</p>
</div>
<div class="section" id="making-actions-public">
<h3>Making actions public<a class="headerlink" href="#making-actions-public" title="永久链接至标题">¶</a></h3>
<p>There are often times controller actions that you wish to remain
entirely public, or that don&#8217;t require users to be logged in.
AuthComponent is pessimistic, and defaults to denying access. You can
mark actions as public actions by using <tt class="docutils literal"><span class="pre">AuthComponent::allow()</span></tt>.  By
marking actions as public, AuthComponent, will not check for a logged in
user, nor will authorize objects be checked:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span class="c1">// Allow all actions. CakePHP 2.0</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Auth</span><span class="o">-&gt;</span><span class="na">allow</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">);</span>

<span class="c1">// Allow all actions. CakePHP 2.1</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Auth</span><span class="o">-&gt;</span><span class="na">allow</span><span class="p">();</span>

<span class="c1">// Allow only the view and index actions.</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Auth</span><span class="o">-&gt;</span><span class="na">allow</span><span class="p">(</span><span class="s1">&#39;view&#39;</span><span class="p">,</span> <span class="s1">&#39;index&#39;</span><span class="p">);</span>

<span class="c1">// Allow only the view and index actions.</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Auth</span><span class="o">-&gt;</span><span class="na">allow</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">&#39;view&#39;</span><span class="p">,</span> <span class="s1">&#39;index&#39;</span><span class="p">));</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">警告</p>
<p class="last">If you&#8217;re using scaffolding, allow all will not identify and allow the
scaffolded methods. You have to specify their action names.</p>
</div>
<p>You can provide as many action names as you need to <tt class="docutils literal"><span class="pre">allow()</span></tt>.  You can
also supply an array containing all the action names.</p>
</div>
<div class="section" id="making-actions-require-authorization">
<h3>Making actions require authorization<a class="headerlink" href="#making-actions-require-authorization" title="永久链接至标题">¶</a></h3>
<p>By default all actions require authorization. However, after making actions
public, you want to revoke the public access.  You can do so using
<tt class="docutils literal"><span class="pre">AuthComponent::deny()</span></tt>:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span class="c1">// remove one action</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Auth</span><span class="o">-&gt;</span><span class="na">deny</span><span class="p">(</span><span class="s1">&#39;add&#39;</span><span class="p">);</span>

<span class="c1">// remove all the actions.</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Auth</span><span class="o">-&gt;</span><span class="na">deny</span><span class="p">();</span>

<span class="c1">// remove a group of actions.</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Auth</span><span class="o">-&gt;</span><span class="na">deny</span><span class="p">(</span><span class="s1">&#39;add&#39;</span><span class="p">,</span> <span class="s1">&#39;edit&#39;</span><span class="p">);</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Auth</span><span class="o">-&gt;</span><span class="na">deny</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">&#39;add&#39;</span><span class="p">,</span> <span class="s1">&#39;edit&#39;</span><span class="p">));</span>
</pre></div>
</div>
<p>You can provide as many action names as you need to <tt class="docutils literal"><span class="pre">deny()</span></tt>.  You can
also supply an array containing all the action names.</p>
</div>
<div class="section" id="using-controllerauthorize">
<h3>Using ControllerAuthorize<a class="headerlink" href="#using-controllerauthorize" title="永久链接至标题">¶</a></h3>
<p>ControllerAuthorize allows you to handle authorization checks in a
controller callback. This is ideal when you have very simple
authorization, or you need to use a combination of models + components
to do your authorization, and don&#8217;t want to create a custom authorize
object.</p>
<p>The callback is always called <tt class="docutils literal"><span class="pre">isAuthorized()</span></tt> and it should return a
boolean as to whether or not the user is allowed to access resources in
the request. The callback is passed the active user, so it can be
checked:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span class="k">class</span> <span class="nc">AppController</span> <span class="k">extends</span> <span class="nx">Controller</span> <span class="p">{</span>
    <span class="k">public</span> <span class="nv">$components</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">&#39;Auth&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;authorize&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Controller&#39;</span><span class="p">),</span>
    <span class="p">);</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">isAuthorized</span><span class="p">(</span><span class="nv">$user</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Any registered user can access public functions</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">params</span><span class="p">[</span><span class="s1">&#39;admin&#39;</span><span class="p">]))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// Only admins can access admin functions</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">params</span><span class="p">[</span><span class="s1">&#39;admin&#39;</span><span class="p">]))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="p">(</span><span class="nx">bool</span><span class="p">)(</span><span class="nv">$user</span><span class="p">[</span><span class="s1">&#39;role&#39;</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;admin&#39;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">// Default deny</span>
        <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The above callback would provide a very simple authorization system
where, only users with role = admin could access actions that were in
the admin prefix.</p>
</div>
<div class="section" id="using-actionsauthorize">
<h3>Using ActionsAuthorize<a class="headerlink" href="#using-actionsauthorize" title="永久链接至标题">¶</a></h3>
<p>ActionsAuthorize integrates with the AclComponent, and provides a fine
grained per action ACL check on each request.  ActionsAuthorize is often
paired with DbAcl to give dynamic and flexible permission systems that
can be edited by admin users through the application.  It can however,
be combined with other Acl implementations such as IniAcl and custom
application Acl backends.</p>
</div>
<div class="section" id="using-crudauthorize">
<h3>Using CrudAuthorize<a class="headerlink" href="#using-crudauthorize" title="永久链接至标题">¶</a></h3>
<p><tt class="docutils literal"><span class="pre">CrudAuthorize</span></tt> integrates with AclComponent, and provides the ability to
map requests to CRUD operations.  Provides the ability to authorize
using CRUD mappings. These mapped results are then checked in the
AclComponent as specific permissions.</p>
<p>For example, taking <tt class="docutils literal"><span class="pre">/posts/index</span></tt> as the current request.  The default
mapping for <tt class="docutils literal"><span class="pre">index</span></tt>, is a <tt class="docutils literal"><span class="pre">read</span></tt> permission check. The Acl check would
then be for the <tt class="docutils literal"><span class="pre">posts</span></tt> controller with the <tt class="docutils literal"><span class="pre">read</span></tt> permission.  This
allows you to create permission systems that focus more on what is being
done to resources, rather than the specific actions being visited.</p>
</div>
<div class="section" id="mapping-actions-when-using-crudauthorize">
<h3>Mapping actions when using CrudAuthorize<a class="headerlink" href="#mapping-actions-when-using-crudauthorize" title="永久链接至标题">¶</a></h3>
<p>When using CrudAuthorize or any other authorize objects that use action
mappings, it might be necessary to map additional methods.  You can
map actions -&gt; CRUD permissions using mapAction().  Calling this on
AuthComponent will delegate to all the of the configured authorize
objects, so you can be sure the settings were applied every where:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Auth</span><span class="o">-&gt;</span><span class="na">mapActions</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
    <span class="s1">&#39;create&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;register&#39;</span><span class="p">),</span>
    <span class="s1">&#39;view&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;show&#39;</span><span class="p">,</span> <span class="s1">&#39;display&#39;</span><span class="p">)</span>
<span class="p">));</span>
</pre></div>
</div>
<p>The keys for mapActions should be the CRUD permissions you want to set,
while the values should be an array of all the actions that are mapped
to the CRUD permission.</p>
</div>
</div>
<div class="section" id="authcomponent-api">
<h2>AuthComponent API<a class="headerlink" href="#authcomponent-api" title="永久链接至标题">¶</a></h2>
<p>AuthComponent is the primary interface to the built-in authorization
and authentication mechanics in CakePHP.</p>
<dl class="attr">
<dt id="AuthComponent::$ajaxLogin">
<em class="property">property </em><tt class="descclassname">AuthComponent::$</tt><tt class="descname">ajaxLogin</tt><a class="headerlink" href="#AuthComponent::$ajaxLogin" title="永久链接至目标">¶</a></dt>
<dd><p>The name of an optional view element to render when an Ajax request is made
with an invalid or expired session.</p>
</dd></dl>

<dl class="attr">
<dt id="AuthComponent::$authenticate">
<em class="property">property </em><tt class="descclassname">AuthComponent::$</tt><tt class="descname">authenticate</tt><a class="headerlink" href="#AuthComponent::$authenticate" title="永久链接至目标">¶</a></dt>
<dd><p>Set to an array of Authentication objects you want to use when
logging users in. There are several core authentication objects,
see the section on <a class="reference internal" href="#authentication-objects"><em>Authentication 认证</em></a>.</p>
</dd></dl>

<dl class="attr">
<dt id="AuthComponent::$authError">
<em class="property">property </em><tt class="descclassname">AuthComponent::$</tt><tt class="descname">authError</tt><a class="headerlink" href="#AuthComponent::$authError" title="永久链接至目标">¶</a></dt>
<dd><p>Error to display when user attempts to access an object or action to which
they do not have access.</p>
</dd></dl>

<dl class="attr">
<dt id="AuthComponent::$authorize">
<em class="property">property </em><tt class="descclassname">AuthComponent::$</tt><tt class="descname">authorize</tt><a class="headerlink" href="#AuthComponent::$authorize" title="永久链接至目标">¶</a></dt>
<dd><p>Set to an array of Authorization objects you want to use when
authorizing users on each request, see the section on
<a class="reference internal" href="#authorization-objects"><em>Authorization</em></a>.</p>
</dd></dl>

<dl class="attr">
<dt id="AuthComponent::$components">
<em class="property">property </em><tt class="descclassname">AuthComponent::$</tt><tt class="descname">components</tt><a class="headerlink" href="#AuthComponent::$components" title="永久链接至目标">¶</a></dt>
<dd><p>Other components utilized by AuthComponent</p>
</dd></dl>

<dl class="attr">
<dt id="AuthComponent::$flash">
<em class="property">property </em><tt class="descclassname">AuthComponent::$</tt><tt class="descname">flash</tt><a class="headerlink" href="#AuthComponent::$flash" title="永久链接至目标">¶</a></dt>
<dd><p>Settings to use when Auth needs to do a flash message with
<a class="reference internal" href="sessions.html#SessionComponent::setFlash" title="SessionComponent::setFlash"><tt class="xref php php-meth docutils literal"><span class="pre">SessionComponent::setFlash()</span></tt></a>.
Available keys are:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">element</span></tt> - The element to use, defaults to &#8216;default&#8217;.</li>
<li><tt class="docutils literal"><span class="pre">key</span></tt> - The key to use, defaults to &#8216;auth&#8217;</li>
<li><tt class="docutils literal"><span class="pre">params</span></tt> - The array of additional params to use, defaults to array()</li>
</ul>
</dd></dl>

<dl class="attr">
<dt id="AuthComponent::$loginAction">
<em class="property">property </em><tt class="descclassname">AuthComponent::$</tt><tt class="descname">loginAction</tt><a class="headerlink" href="#AuthComponent::$loginAction" title="永久链接至目标">¶</a></dt>
<dd><p>A URL (defined as a string or array) to the controller action that handles
logins.  Defaults to <cite>/users/login</cite></p>
</dd></dl>

<dl class="attr">
<dt id="AuthComponent::$loginRedirect">
<em class="property">property </em><tt class="descclassname">AuthComponent::$</tt><tt class="descname">loginRedirect</tt><a class="headerlink" href="#AuthComponent::$loginRedirect" title="永久链接至目标">¶</a></dt>
<dd><p>The URL (defined as a string or array) to the controller action users
should be redirected to after logging in. This value will be ignored if the
user has an <tt class="docutils literal"><span class="pre">Auth.redirect</span></tt> value in their session.</p>
</dd></dl>

<dl class="attr">
<dt id="AuthComponent::$logoutRedirect">
<em class="property">property </em><tt class="descclassname">AuthComponent::$</tt><tt class="descname">logoutRedirect</tt><a class="headerlink" href="#AuthComponent::$logoutRedirect" title="永久链接至目标">¶</a></dt>
<dd><p>The default action to redirect to after the user is logged out. While
AuthComponent does not handle post-logout redirection, a redirect URL will
be returned from <a class="reference internal" href="#AuthComponent::logout" title="AuthComponent::logout"><tt class="xref php php-meth docutils literal"><span class="pre">AuthComponent::logout()</span></tt></a>. Defaults to
<a class="reference internal" href="#AuthComponent::$loginAction" title="AuthComponent::$loginAction"><tt class="xref php php-attr docutils literal"><span class="pre">AuthComponent::$loginAction</span></tt></a>.</p>
</dd></dl>

<dl class="attr">
<dt id="AuthComponent::$unauthorizedRedirect">
<em class="property">property </em><tt class="descclassname">AuthComponent::$</tt><tt class="descname">unauthorizedRedirect</tt><a class="headerlink" href="#AuthComponent::$unauthorizedRedirect" title="永久链接至目标">¶</a></dt>
<dd><p>Controls handling of unauthorized access. By default unauthorized user is
redirected to the referrer url or <tt class="docutils literal"><span class="pre">AuthComponent::$loginAction</span></tt> or &#8216;/&#8217;.
If set to false a ForbiddenException exception is thrown instead of redirecting.</p>
</dd></dl>

<dl class="attr">
<dt id="AuthComponent::$request">
<em class="property">property </em><tt class="descclassname">AuthComponent::$</tt><tt class="descname">request</tt><a class="headerlink" href="#AuthComponent::$request" title="永久链接至目标">¶</a></dt>
<dd><p>Request object</p>
</dd></dl>

<dl class="attr">
<dt id="AuthComponent::$response">
<em class="property">property </em><tt class="descclassname">AuthComponent::$</tt><tt class="descname">response</tt><a class="headerlink" href="#AuthComponent::$response" title="永久链接至目标">¶</a></dt>
<dd><p>Response object</p>
</dd></dl>

<dl class="attr">
<dt id="AuthComponent::$sessionKey">
<em class="property">property </em><tt class="descclassname">AuthComponent::$</tt><tt class="descname">sessionKey</tt><a class="headerlink" href="#AuthComponent::$sessionKey" title="永久链接至目标">¶</a></dt>
<dd><p>The session key name where the record of the current user is stored. If
unspecified, it will be &#8220;Auth.User&#8221;.</p>
</dd></dl>

<dl class="method">
<dt id="AuthComponent::allow">
<tt class="descclassname">AuthComponent::</tt><tt class="descname">allow</tt><big>(</big><em>$action</em><span class="optional">[</span>, <em>$action</em>, <em>...</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#AuthComponent::allow" title="永久链接至目标">¶</a></dt>
<dd><p>Set one or more actions as public actions, this means that no
authorization checks will be performed for the specified actions.
The special value of <tt class="docutils literal"><span class="pre">'*'</span></tt> will mark all the current controllers
actions as public. Best used in your controller&#8217;s beforeFilter
method.</p>
</dd></dl>

<dl class="method">
<dt id="AuthComponent::constructAuthenticate">
<tt class="descclassname">AuthComponent::</tt><tt class="descname">constructAuthenticate</tt><big>(</big><big>)</big><a class="headerlink" href="#AuthComponent::constructAuthenticate" title="永久链接至目标">¶</a></dt>
<dd><p>Loads the configured authentication objects.</p>
</dd></dl>

<dl class="method">
<dt id="AuthComponent::constructAuthorize">
<tt class="descclassname">AuthComponent::</tt><tt class="descname">constructAuthorize</tt><big>(</big><big>)</big><a class="headerlink" href="#AuthComponent::constructAuthorize" title="永久链接至目标">¶</a></dt>
<dd><p>Loads the authorization objects configured.</p>
</dd></dl>

<dl class="method">
<dt id="AuthComponent::deny">
<tt class="descclassname">AuthComponent::</tt><tt class="descname">deny</tt><big>(</big><em>$action</em><span class="optional">[</span>, <em>$action</em>, <em>...</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#AuthComponent::deny" title="永久链接至目标">¶</a></dt>
<dd><p>Toggle one more more actions previously declared as public actions,
as non-public methods.  These methods will now require
authorization.  Best used inside your controller&#8217;s beforeFilter
method.</p>
</dd></dl>

<dl class="method">
<dt id="AuthComponent::flash">
<tt class="descclassname">AuthComponent::</tt><tt class="descname">flash</tt><big>(</big><em>$message</em><big>)</big><a class="headerlink" href="#AuthComponent::flash" title="永久链接至目标">¶</a></dt>
<dd><p>Set a flash message. Uses the Session component, and values from
<a class="reference internal" href="#AuthComponent::$flash" title="AuthComponent::$flash"><tt class="xref php php-attr docutils literal"><span class="pre">AuthComponent::$flash</span></tt></a>.</p>
</dd></dl>

<dl class="method">
<dt id="AuthComponent::identify">
<tt class="descclassname">AuthComponent::</tt><tt class="descname">identify</tt><big>(</big><em>$request</em>, <em>$response</em><big>)</big><a class="headerlink" href="#AuthComponent::identify" title="永久链接至目标">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">参数:</th><td class="field-body"><ul class="first last simple">
<li><strong>$request</strong> (<a class="reference internal" href="../../controllers/request-response.html#CakeRequest" title="CakeRequest"><em>CakeRequest</em></a>) &#8211; The request to use.</li>
<li><strong>$response</strong> (<a class="reference internal" href="../../controllers/request-response.html#CakeResponse" title="CakeResponse"><em>CakeResponse</em></a>) &#8211; The response to use, headers can be
sent if authentication fails.</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>This method is used by AuthComponent to identify a user based on the
information contained in the current request.</p>
</dd></dl>

<dl class="method">
<dt id="AuthComponent::initialize">
<tt class="descclassname">AuthComponent::</tt><tt class="descname">initialize</tt><big>(</big><em>$Controller</em><big>)</big><a class="headerlink" href="#AuthComponent::initialize" title="永久链接至目标">¶</a></dt>
<dd><p>Initializes AuthComponent for use in the controller.</p>
</dd></dl>

<dl class="method">
<dt id="AuthComponent::isAuthorized">
<tt class="descclassname">AuthComponent::</tt><tt class="descname">isAuthorized</tt><big>(</big><em>$user = null</em>, <em>$request = null</em><big>)</big><a class="headerlink" href="#AuthComponent::isAuthorized" title="永久链接至目标">¶</a></dt>
<dd><p>Uses the configured Authorization adapters to check whether or not a user
is authorized. Each adapter will be checked in sequence, if any of them
return true, then the user will be authorized for the request.</p>
</dd></dl>

<dl class="method">
<dt id="AuthComponent::loggedIn">
<tt class="descclassname">AuthComponent::</tt><tt class="descname">loggedIn</tt><big>(</big><big>)</big><a class="headerlink" href="#AuthComponent::loggedIn" title="永久链接至目标">¶</a></dt>
<dd><p>Returns true if the current client is a logged in user, or false if
they are not.</p>
</dd></dl>

<dl class="method">
<dt id="AuthComponent::login">
<tt class="descclassname">AuthComponent::</tt><tt class="descname">login</tt><big>(</big><em>$user</em><big>)</big><a class="headerlink" href="#AuthComponent::login" title="永久链接至目标">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">参数:</th><td class="field-body"><ul class="first last simple">
<li><strong>$user</strong> (<em>array</em>) &#8211; Array of logged in user data.</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>Takes an array of user data to login with.  Allows for manual
logging of users.  Calling user() will populate the session value
with the provided information.  If no user is provided,
AuthComponent will try to identify a user using the current request
information.  See <a class="reference internal" href="#AuthComponent::identify" title="AuthComponent::identify"><tt class="xref php php-meth docutils literal"><span class="pre">AuthComponent::identify()</span></tt></a></p>
</dd></dl>

<dl class="method">
<dt id="AuthComponent::logout">
<tt class="descclassname">AuthComponent::</tt><tt class="descname">logout</tt><big>(</big><big>)</big><a class="headerlink" href="#AuthComponent::logout" title="永久链接至目标">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">返回:</th><td class="field-body">A string url to redirect the logged out user to.</td>
</tr>
</tbody>
</table>
<p>Logs out the current user.</p>
</dd></dl>

<dl class="method">
<dt id="AuthComponent::mapActions">
<tt class="descclassname">AuthComponent::</tt><tt class="descname">mapActions</tt><big>(</big><em>$map = array()</em><big>)</big><a class="headerlink" href="#AuthComponent::mapActions" title="永久链接至目标">¶</a></dt>
<dd><p>Maps action names to CRUD operations. Used for controller-based
authentication. Make sure to configure the authorize property before
calling this method. As it delegates $map to all the attached authorize
objects.</p>
</dd></dl>

<dl class="staticmethod">
<dt id="AuthComponent::password">
<em class="property">static </em><tt class="descclassname">AuthComponent::</tt><tt class="descname">password</tt><big>(</big><em>$pass</em><big>)</big><a class="headerlink" href="#AuthComponent::password" title="永久链接至目标">¶</a></dt>
<dd><p>Hash a password with the application&#8217;s salt value.</p>
</dd></dl>

<dl class="method">
<dt id="AuthComponent::redirect">
<tt class="descclassname">AuthComponent::</tt><tt class="descname">redirect</tt><big>(</big><em>$url = null</em><big>)</big><a class="headerlink" href="#AuthComponent::redirect" title="永久链接至目标">¶</a></dt>
<dd><p>Deprecated since 2.3. See <a class="reference internal" href="#AuthComponent::redirectUrl" title="AuthComponent::redirectUrl"><tt class="xref php php-meth docutils literal"><span class="pre">AuthComponent::redirectUrl()</span></tt></a> for description.</p>
</dd></dl>

<dl class="method">
<dt id="AuthComponent::redirectUrl">
<tt class="descclassname">AuthComponent::</tt><tt class="descname">redirectUrl</tt><big>(</big><em>$url = null</em><big>)</big><a class="headerlink" href="#AuthComponent::redirectUrl" title="永久链接至目标">¶</a></dt>
<dd><p>If no parameter is passed, gets the authentication redirect URL. Pass a
url in to set the destination a user should be redirected to upon logging
in. Will fallback to <a class="reference internal" href="#AuthComponent::$loginRedirect" title="AuthComponent::$loginRedirect"><tt class="xref php php-attr docutils literal"><span class="pre">AuthComponent::$loginRedirect</span></tt></a> if there is
no stored redirect value.</p>
</dd></dl>

<div class="versionadded">
<p><span class="versionmodified">2.3 新版功能.</span></p>
</div>
<dl class="method">
<dt id="AuthComponent::shutdown">
<tt class="descclassname">AuthComponent::</tt><tt class="descname">shutdown</tt><big>(</big><em>$Controller</em><big>)</big><a class="headerlink" href="#AuthComponent::shutdown" title="永久链接至目标">¶</a></dt>
<dd><p>Component shutdown. If user is logged in, wipe out redirect.</p>
</dd></dl>

<dl class="method">
<dt id="AuthComponent::startup">
<tt class="descclassname">AuthComponent::</tt><tt class="descname">startup</tt><big>(</big><em>$Controller</em><big>)</big><a class="headerlink" href="#AuthComponent::startup" title="永久链接至目标">¶</a></dt>
<dd><p>Main execution method. Handles redirecting of invalid users, and
processing of login form data.</p>
</dd></dl>

<dl class="staticmethod">
<dt id="AuthComponent::user">
<em class="property">static </em><tt class="descclassname">AuthComponent::</tt><tt class="descname">user</tt><big>(</big><em>$key = null</em><big>)</big><a class="headerlink" href="#AuthComponent::user" title="永久链接至目标">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">参数:</th><td class="field-body"><ul class="first last simple">
<li><strong>$key</strong> (<em>string</em>) &#8211; The user data key you want to fetch if null,
all user data will be returned.  Can also be called as an instance
method.</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>Get data concerning the currently logged in user, you can use a
property key to fetch specific data about the user:</p>
<div class="highlight-phpinline"><div class="highlight"><pre><span class="nv">$id</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Auth</span><span class="o">-&gt;</span><span class="na">user</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">);</span>
</pre></div>
</div>
<p>If the current user is not logged in or the key doesn&#8217;t exist, null will
be returned.</p>
</dd></dl>

</div>
</div>


		</div>
	</div>

	<div class="sidebar columns three pull-nine">
<div id="sidebar-navigation" class="hide-on-phones">
	<h2 class="hide-on-desktops">Table of Contents</h2>
	<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../index.html">欢迎</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">安装</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting-started.html">入门指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cakephp-overview.html">CakePHP 概述</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../controllers.html">控制器</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../views.html">视图</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../models.html">模型</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../core-libraries.html">核心库</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../toc-general-purpose.html">通用</a></li>
<li class="toctree-l2"><a class="reference internal" href="../toc-behaviors.html">行为</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../toc-components.html">组件</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="pagination.html">Pagination</a></li>
<li class="toctree-l3"><a class="reference internal" href="flash.html">Flash</a></li>
<li class="toctree-l3"><a class="reference internal" href="sessions.html">Sessions</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="">Authentication 认证</a></li>
<li class="toctree-l3"><a class="reference internal" href="security-component.html">Form tampering prevention</a></li>
<li class="toctree-l3"><a class="reference internal" href="security-component.html#csrf-protection">CSRF protection</a></li>
<li class="toctree-l3"><a class="reference internal" href="request-handling.html">请求处理</a></li>
<li class="toctree-l3"><a class="reference internal" href="cookie.html">Cookie</a></li>
<li class="toctree-l3"><a class="reference internal" href="access-control-lists.html">访问控制列表组件</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../toc-helpers.html">助件</a></li>
<li class="toctree-l2"><a class="reference internal" href="../toc-utilities.html">工具</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../plugins.html">插件</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../console-and-shells.html">命令行与Shells</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../development.html">开发</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../deployment.html">部署</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials-and-examples.html">教程 &amp; 实例</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing.html">贡献</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../appendices.html">Appendices</a></li>
</ul>

</div>

<div class="page-contents">
	<h3>Page contents</h3>
	<ul>
<li><a class="reference internal" href="#">Authentication 认证</a><ul>
<li><a class="reference internal" href="#authentication-objects">Authentication 认证</a><ul>
<li><a class="reference internal" href="#creating-custom-authentication-objects">Creating Custom Authentication objects</a></li>
<li><a class="reference internal" href="#using-custom-authentication-objects">Using custom authentication objects</a><ul>
<li><a class="reference internal" href="#using-digest-and-basic-authentication-for-logging-in">Using Digest and Basic Authentication for logging in</a></li>
</ul>
</li>
<li><a class="reference internal" href="#creating-stateless-authentication-systems">Creating stateless authentication systems</a></li>
<li><a class="reference internal" href="#displaying-auth-related-flash-messages">Displaying auth related flash messages</a></li>
<li><a class="reference internal" href="#hashing-passwords">Hashing passwords</a><ul>
<li><a class="reference internal" href="#hashing-passwords-for-digest-authentication">Hashing passwords for digest authentication</a></li>
</ul>
</li>
<li><a class="reference internal" href="#using-bcrypt-for-passwords">Using bcrypt for passwords</a></li>
<li><a class="reference internal" href="#manually-logging-users-in">Manually logging users in</a></li>
<li><a class="reference internal" href="#accessing-the-logged-in-user">Accessing the logged in user</a></li>
<li><a class="reference internal" href="#logging-users-out">Logging users out</a></li>
</ul>
</li>
<li><a class="reference internal" href="#authorization">Authorization</a><ul>
<li><a class="reference internal" href="#configuring-authorization-handlers">Configuring Authorization handlers</a></li>
<li><a class="reference internal" href="#creating-custom-authorize-objects">Creating Custom Authorize objects</a><ul>
<li><a class="reference internal" href="#using-custom-authorize-objects">Using custom authorize objects</a></li>
</ul>
</li>
<li><a class="reference internal" href="#using-no-authorization">Using no authorization</a></li>
<li><a class="reference internal" href="#making-actions-public">Making actions public</a></li>
<li><a class="reference internal" href="#making-actions-require-authorization">Making actions require authorization</a></li>
<li><a class="reference internal" href="#using-controllerauthorize">Using ControllerAuthorize</a></li>
<li><a class="reference internal" href="#using-actionsauthorize">Using ActionsAuthorize</a></li>
<li><a class="reference internal" href="#using-crudauthorize">Using CrudAuthorize</a></li>
<li><a class="reference internal" href="#mapping-actions-when-using-crudauthorize">Mapping actions when using CrudAuthorize</a></li>
</ul>
</li>
<li><a class="reference internal" href="#authcomponent-api">AuthComponent API</a></li>
</ul>
</li>
</ul>

</div>
	</div>

</div>

<div class="content row">
	<ul class="related-pages inline">
	<li>
		<a href="../../genindex.html" title="总目录" accesskey="I">索引</a>
	</li>
	<li>
		<a href="security-component.html" title="Form tampering prevention" accesskey="N">下一页</a>
	</li>
	<li>
		<a href="sessions.html" title="Sessions" accesskey="P">上一页</a>
	</li>
	</ul>
</div>

	<div class="footer-push"> </div>
</div>






<div class="footer">
	<div class="row">
		<div class="columns six offset-by-three contribute">
			<strong>发现翻译错误?</strong>
			请在下方留言<br />
			<a href="https://github.com/blackpuppy/docs/wiki" target="_blank">[ 我要加入翻译 ]</a>
		</div>
	</div>
	
	<div class="row">
		<div class="columns nine offset-by-three copyright">
					&copy; 版权所有 2014, Cake Software Foundation, Inc.
				最后更新于 Aug 31, 2015.
				Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.2.3.
			Sponsored by <a href="http://www.shinetechzhengzhou.com/" target="_blank">盛安德郑州</a>
		</div>
	</div>
</div>

<div id="nav-modal" class="reveal-modal"> </div>
<div id="inline-search-results"></div>
<script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F201cbc61deaf9f7ffb521fb23e83db40' type='text/javascript'%3E%3C/script%3E"));
</script>

<!-- Duoshuo Comment BEGIN -->
	<div class="ds-thread"></div>
<script type="text/javascript">
var duoshuoQuery = {short_name:"cakephpchina"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = 'http://static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0]
		|| document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
<!-- Duoshuo Comment END -->
  </body>
</html>